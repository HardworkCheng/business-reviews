 
# 优惠券审计与改进方案

## 1. 审计范围
本次审计覆盖以下模块与文件：
- App 端优惠券接口：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`
- 秒杀接口：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/SeckillController.java`
- 商家端优惠券接口：`backend-business-reviews-web/src/main/java/com/businessreviews/web/merchant/MerchantCouponController.java`
- 商家端优惠券服务：`backend-business-reviews-service/src/main/java/com/businessreviews/service/impl/merchant/MerchantCouponServiceImpl.java`
- Mapper：`backend-business-reviews-mapper/src/main/java/com/businessreviews/mapper/CouponMapper.java`、`backend-business-reviews-mapper/src/main/java/com/businessreviews/mapper/UserCouponMapper.java`
- 数据模型：`backend-business-reviews-entity/src/main/java/com/businessreviews/model/dataobject/CouponDO.java`、`backend-business-reviews-entity/src/main/java/com/businessreviews/model/dataobject/UserCouponDO.java`、`backend-business-reviews-entity/src/main/java/com/businessreviews/model/dto/merchant/CreateCouponDTO.java`
- SQL 设计：`backend-business-reviews/sql/business_reviews.sql`、`backend-business-reviews/sql/additional_tables.sql`、`backend-business-reviews/sql/coupon_redesign_tables.sql`

## 2. 当前业务流程简述
### 2.1 App 端
- 列表查询：`/app/coupons`、`/app/coupons/available`
- 领取优惠券：`/app/coupons/{couponId}/claim`（含兼容接口 `/receive`）
- 我的优惠券：`/app/coupons/my`
- 详情：`/app/coupons/{couponId}`

### 2.2 商家端
- 列表、详情：`/merchant/coupons`、`/merchant/coupons/{id}`
- 创建、更新、上下架：`/merchant/coupons`、`/merchant/coupons/{id}`、`/merchant/coupons/{id}/status`
- 核销、校验：`/merchant/coupons/{id}/redeem`、`/merchant/coupons/verify`

### 2.3 秒杀（简化实现）
- 入口：`/app/seckill/activities`、`/app/seckill/{seckillId}/coupons/{couponId}/claim`
- 当前实现为简化版（不基于 seckill_* 表），使用普通优惠券模拟。

## 3. 核心问题清单（按优先级）
### P0（高风险）
1) 领取逻辑非原子，存在超卖/重复领取风险  
   - App 端领取与秒杀领取都采用“查询-插入-更新”三步，且缺少事务控制和原子扣减。  
   - `CouponMapper.decrementStock` 已存在但未使用。  
   - 涉及文件：  
     - `backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`  
     - `backend-business-reviews-web/src/main/java/com/businessreviews/web/app/SeckillController.java`  
     - `backend-business-reviews-mapper/src/main/java/com/businessreviews/mapper/CouponMapper.java`

2) 用户领取上限存在并发穿透  
   - 仅通过 `selectCount` 判断是否超限，没有唯一索引与并发保护。  
   - `user_coupons` 表缺少 `(user_id, coupon_id)` 的唯一约束。  
   - 涉及文件：  
     - `backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`  
     - `backend-business-reviews/sql/business_reviews.sql`

3) 秒杀接口仅使用 JVM 内锁  
   - `synchronized (this)` 仅单实例有效，多实例部署会直接失效。  
   - 涉及文件：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/SeckillController.java`

### P1（中高风险）
1) 数据模型与数据库结构不一致  
   - `CouponDO` 中 `dailyLimit/useStartTime/useEndTime` 设为 `@TableField(exist = false)`，但 SQL 版本中存在或预留了相关字段。  
   - 当前代码在核销/校验中使用 `useStartTime/useEndTime`，但从数据库查询得到的值永远为空，导致校验失效。  
   - 涉及文件：  
     - `backend-business-reviews-entity/src/main/java/com/businessreviews/model/dataobject/CouponDO.java`  
     - `backend-business-reviews-service/src/main/java/com/businessreviews/service/impl/merchant/MerchantCouponServiceImpl.java`  
     - `backend-business-reviews/sql/additional_tables.sql`、`backend-business-reviews/sql/business_reviews.sql`

2) 类型与状态含义在代码/SQL中存在多版本冲突  
   - `CouponDO` 与 SQL 注释、DTO 中的类型含义不一致（满减/代金/专属/新人）。  
   - `status` 的枚举含义在 SQL 与代码中存在偏差（0/1 vs 1/2/3）。  
   - 涉及文件：  
     - `backend-business-reviews-entity/src/main/java/com/businessreviews/model/dataobject/CouponDO.java`  
     - `backend-business-reviews-entity/src/main/java/com/businessreviews/model/dto/merchant/CreateCouponDTO.java`  
     - `backend-business-reviews/sql/business_reviews.sql`、`backend-business-reviews/sql/additional_tables.sql`

3) 核销未校验门店归属  
   - 商家核销仅校验 `merchantId`，未校验 `coupon.shopId` 与 `shopId` 的一致性。  
   - 可能导致“门店 A 的券在门店 B 核销”的问题。  
   - 涉及文件：`backend-business-reviews-service/src/main/java/com/businessreviews/service/impl/merchant/MerchantCouponServiceImpl.java`

4) 更新总量可能导致库存为负  
   - `remainCount = remainCount + diff`，当减少总量且已领取数量超过新总量时会出现负值。  
   - 涉及文件：`backend-business-reviews-service/src/main/java/com/businessreviews/service/impl/merchant/MerchantCouponServiceImpl.java`

5) 领取接口无事务保护  
   - App 端 `claimCoupon` 未标注 `@Transactional`，异常会造成“已领券但库存未扣/扣了但未领”的不一致。  
   - 涉及文件：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`

### P2（中低风险）
1) 过期状态没有统一更新机制  
   - `user_coupons.status` 未见定时任务更新，过期券可能仍显示“未使用”。  
   - 涉及文件：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`

2) N+1 查询问题  
   - 列表与我的券转换时逐条查询 `shop` 与 `coupon`。  
   - 涉及文件：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`  

3) 统计表与存储过程未落地  
   - `coupon_statistics`、`coupon_view_logs`、`coupon_search_logs`、`sp_claim_coupon` 等存在，但业务代码未使用。  
   - 涉及文件：`backend-business-reviews/sql/coupon_redesign_tables.sql`

4) 时间边界与状态展示不一致  
   - 详情接口未明确标记已过期状态，状态渲染逻辑不统一。  
   - 涉及文件：`backend-business-reviews-web/src/main/java/com/businessreviews/web/app/CouponController.java`

## 4. 改进清单（建议落地顺序）
### P0 - 必须优先
1) 原子扣减库存  
   - App 与秒杀领取统一改为 `UPDATE coupons SET remain_count = remain_count - 1 WHERE id = ? AND remain_count > 0`，通过返回值判断是否成功。  
   - 建议复用 `CouponMapper.decrementStock`，并在领取失败时直接返回“已领完”。  

2) 并发防重与幂等  
   - 在 `user_coupons` 表新增唯一索引：`(user_id, coupon_id)`。  
   - 领取时先尝试插入，捕获唯一键异常并返回“已领取”。  

3) 秒杀改为分布式锁或数据库原子扣减  
   - 多实例环境下需使用 Redis 锁或数据库扣减策略。  
   - 结合 `seckill_coupons` 表实现真正的秒杀活动。  

### P1 - 重要优化
1) 统一数据模型与数据库结构  
   - 明确是否保留 `use_start_time/use_end_time/daily_limit`，统一 DO 与 SQL。  
   - 核销与校验逻辑应基于真实字段，不使用 `exist=false` 的字段。  

2) 规范优惠券类型与状态枚举  
   - 建议定义统一的 `enum`，并在 DTO/DO/SQL 中保持一致。  
   - 同时更新前端与文档。  

3) 核销门店校验  
   - `coupon.shopId != null` 时强制 `shopId` 一致；  
   - 校验 `shopId` 必须属于当前 `merchantId`。  

4) 库存调整保护  
   - 当更新总量时，`remainCount` 应满足 `remainCount >= 0`，并确保 `totalCount >= claimedCount`。  
   - 建议改为 `remainCount = max(totalCount - claimedCount, 0)`。  

5) App 领取事务保护  
   - 领取流程纳入事务，保证插入与扣库存一致。  

### P2 - 体验与性能优化
1) 列表与“我的券”N+1优化  
   - 批量查询 `shop` 与 `coupon`，或使用联表查询。  

2) 过期状态统一处理  
   - 增加定时任务或查询时计算过期状态，避免数据长期不一致。  

3) 统计与日志落地  
   - 使用 `coupon_view_logs`、`coupon_search_logs` 记录行为；  
   - 使用 `coupon_statistics` 存储每日统计，减少实时聚合成本。  

## 5. 建议测试用例
- 并发领取同一优惠券（100+ 并发，验证库存与每人限制）。  
- 用户重复领取（并发/串行）能否正确拦截。  
- 优惠券状态变更：停用后不可领取，结束后不可核销。  
- 更新总量后库存是否正确。  
- 核销时门店与商家归属校验。  
- 过期逻辑（到期边界、已过期券展示）。  

## 6. 小结
当前优惠券模块功能齐全，但在并发、数据一致性与模型一致性方面存在明显风险。  
优先解决“库存扣减原子性 + 防重约束 + 秒杀并发”三类问题，再逐步规范数据模型与统计体系。
