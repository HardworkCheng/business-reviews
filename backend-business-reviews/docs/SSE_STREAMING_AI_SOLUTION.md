# SSE æµå¼ AI å“åº”æŠ€æœ¯æ–¹æ¡ˆ

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† Business Reviews ç³»ç»Ÿä¸­ AI å†…å®¹ç”Ÿæˆçš„æµå¼è¾“å‡ºï¼ˆSSEï¼‰å®ç°æ–¹æ¡ˆï¼Œæä¾› ChatGPT å¼çš„æ‰“å­—æœºæ•ˆæœä½“éªŒã€‚

## ğŸ“‹ ç›®å½•

1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [æŠ€æœ¯åˆ†æ](#æŠ€æœ¯åˆ†æ)
3. [è§£å†³æ–¹æ¡ˆ](#è§£å†³æ–¹æ¡ˆ)
4. [åç«¯é…ç½®è¯¦è§£](#åç«¯é…ç½®è¯¦è§£)
5. [å‰ç«¯æ¥å…¥æŒ‡å—](#å‰ç«¯æ¥å…¥æŒ‡å—)
6. [SSE äº‹ä»¶åè®®](#sse-äº‹ä»¶åè®®)
7. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
8. [éƒ¨ç½²é…ç½®](#éƒ¨ç½²é…ç½®)
9. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é—®é¢˜èƒŒæ™¯

### åŒæ­¥ AI ç”Ÿæˆçš„ä½“éªŒé—®é¢˜

åœ¨å¼•å…¥æµå¼å“åº”ä¹‹å‰ï¼ŒAI å†…å®¹ç”Ÿæˆé‡‡ç”¨åŒæ­¥æ¨¡å¼ï¼šç”¨æˆ·å‘èµ·è¯·æ±‚åï¼Œéœ€è¦ç­‰å¾…æ•´ä¸ªå†…å®¹ç”Ÿæˆå®Œæˆæ‰èƒ½çœ‹åˆ°ç»“æœã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒæ­¥æ¨¡å¼ç”¨æˆ·ä½“éªŒ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ“ä½œ                      ç³»ç»Ÿå“åº”                    ç”¨æˆ·æ„ŸçŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç‚¹å‡»"AIç”Ÿæˆ" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åç«¯è°ƒç”¨ AI æ¨¡å‹          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              ç­‰å¾…ç”Ÿæˆ...                â”‚ åŠ è½½ä¸­... â”‚
                              ç­‰å¾…ç”Ÿæˆ...                â”‚   ğŸ˜“     â”‚
                              ç­‰å¾…ç”Ÿæˆ...                â”‚ 10ç§’è¿‡å» â”‚
                              ç­‰å¾…ç”Ÿæˆ...ï¼ˆ10-30ç§’ï¼‰      â”‚   ğŸ˜°     â”‚
                              ç”Ÿæˆå®Œæˆï¼        â—„â”€â”€â”€â”€â”€â”€â”€ â”‚ 20ç§’è¿‡å» â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸€æ¬¡æ€§è¿”å›å…¨éƒ¨å†…å®¹         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ˜¾ç¤ºå®Œæ•´å†…å®¹

âŒ é—®é¢˜ï¼š
- é•¿æ—¶é—´ç™½å±/åŠ è½½ï¼Œç”¨æˆ·ç„¦è™‘
- æ— æ³•æå‰é¢„è§ˆå†…å®¹
- æ— æ³•ä¸­é€”å–æ¶ˆ
- ç”¨æˆ·ä¸ç¡®å®šç³»ç»Ÿæ˜¯å¦åœ¨å·¥ä½œ
```

### æµå¼æ¨¡å¼çš„ä¼˜åŠ¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµå¼æ¨¡å¼ç”¨æˆ·ä½“éªŒ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ“ä½œ                      ç³»ç»Ÿå“åº”                    ç”¨æˆ·æ„ŸçŸ¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç‚¹å‡»"AIç”Ÿæˆ" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åç«¯è°ƒç”¨ AI æ¨¡å‹          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: "æ¢"                  â”‚ æ¢       â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: "åº—"                  â”‚ æ¢åº—     â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: "ç¬”"                  â”‚ æ¢åº—ç¬”   â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: "è®°"                  â”‚ æ¢åº—ç¬”è®° â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: "ï¼š" ...              â”‚  ...âœ¨   â”‚
              â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SSE: [DONE]               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ˜¾ç¤ºå®Œæ•´å†…å®¹                  ç”Ÿæˆå®Œæˆï¼

âœ… ä¼˜åŠ¿ï¼š
- é¦–å­— 1-2 ç§’æ˜¾ç¤ºï¼Œå³æ—¶åé¦ˆ
- é€å­—è¾“å‡ºï¼Œä»¿ä½› AI åœ¨"æ€è€ƒ"
- å¯éšæ—¶å–æ¶ˆ
- æ‰“å­—æœºæ•ˆæœï¼Œä½“éªŒæ„Ÿå¥½
```

### é—®é¢˜å½±å“

| æŒ‡æ ‡ | åŒæ­¥æ¨¡å¼ | æµå¼æ¨¡å¼ | æå‡ |
|------|----------|----------|------|
| é¦–å­—æ˜¾ç¤ºæ—¶é—´ | 10-30 ç§’ | 1-2 ç§’ | **â†“ 90%+** |
| ç”¨æˆ·ç„¦è™‘æ„Ÿ | é«˜ | ä½ | â†“ å¤§å¹…é™ä½ |
| ä¸­é€”å–æ¶ˆ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | æ–°å¢ |
| äº¤äº’ä½“éªŒ | ä¸€èˆ¬ | ä¼˜ç§€ | â†‘ æ˜¾è‘—æå‡ |

---

## æŠ€æœ¯åˆ†æ

### SSE vs WebSocket vs è½®è¯¢

| æŠ€æœ¯ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æœ¬åœºæ™¯æ¨èåº¦ |
|------|----------|--------|--------------|
| **SSE** | æœåŠ¡ç«¯å•å‘æ¨é€ | â­ ç®€å• | â­â­â­â­â­ |
| WebSocket | åŒå‘å®æ—¶é€šä¿¡ | â­â­â­ è¾ƒå¤æ‚ | â­â­ |
| è½®è¯¢ | å…¼å®¹æ€§è¦æ±‚æé«˜ | â­â­ ä¸­ç­‰ | â­ |

**ä¸ºä»€ä¹ˆé€‰æ‹© SSEï¼Ÿ**

1. **å•å‘æ¨é€è¶³å¤Ÿ**ï¼šAI ç”Ÿæˆæ˜¯æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å•å‘æ¨é€
2. **åŸºäº HTTP**ï¼šæ— éœ€é¢å¤–åè®®ï¼Œé˜²ç«å¢™å‹å¥½
3. **è‡ªåŠ¨é‡è¿**ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒæ–­çº¿é‡è¿
4. **ç®€å•å®ç°**ï¼šSpring æä¾› `SseEmitter` å¼€ç®±å³ç”¨

### LangChain4j æµå¼æ¨¡å‹

```java
// åŒæ­¥æ¨¡å‹ï¼ˆç­‰å¾…å…¨éƒ¨ç”Ÿæˆï¼‰
ChatLanguageModel model;
String response = model.generate(prompt);  // é˜»å¡ç­‰å¾…

// æµå¼æ¨¡å‹ï¼ˆé€ token å›è°ƒï¼‰
StreamingChatLanguageModel streamingModel;
streamingModel.generate(prompt, new StreamingResponseHandler<>() {
    @Override
    public void onNext(String token) {
        // æ¯ç”Ÿæˆä¸€ä¸ª token è§¦å‘
    }
    @Override
    public void onComplete(Response<AiMessage> response) {
        // ç”Ÿæˆå®Œæˆ
    }
});
```

---

## è§£å†³æ–¹æ¡ˆ

### æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SSE æµå¼ AI å“åº”æ¶æ„                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    POST /generate/stream     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                       â”‚
â”‚  å‰ç«¯åº”ç”¨    â”‚                              â”‚   Spring Controller   â”‚
â”‚  (UniApp)   â”‚                              â”‚   (SseEmitter)        â”‚
â”‚             â”‚ â—„â”€â”€â”€â”€â”€ SSE Connection â”€â”€â”€â”€â”€â”€ â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²                                                  â”‚
      â”‚                                                  â–¼
      â”‚ event: token                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ data: "æ¢"                            â”‚                       â”‚
      â”‚                                       â”‚   VisionNoteStream    â”‚
      â”‚ event: token                          â”‚   ServiceImpl         â”‚
      â”‚ data: "åº—"                            â”‚                       â”‚
      â”‚                                       â”‚   - StreamingChat     â”‚
      â”‚ event: token                          â”‚     LanguageModel     â”‚
      â”‚ data: "ç¬”"                            â”‚   - StreamingResponse â”‚
      â”‚                                       â”‚     Handler           â”‚
      â”‚ event: done                           â”‚                       â”‚
      â”‚ data: [DONE]                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                                   â”‚
      â”‚                                                   â–¼
      â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                        â”‚                       â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é€ token æ˜¾ç¤º â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   é€šä¹‰åƒé—® Qwen-VL    â”‚
                                               â”‚   (æµå¼ API)          â”‚
                                               â”‚                       â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `AiModelConfig` | é…ç½®æµå¼æ¨¡å‹ Bean |
| `VisionNoteStreamService` | æµå¼ç¬”è®°ç”ŸæˆæœåŠ¡æ¥å£ |
| `VisionNoteStreamServiceImpl` | æµå¼ç”Ÿæˆå®ç°ï¼ˆè®¢é˜… token æµï¼‰ |
| `NoteAIController` | æä¾› SSE ç«¯ç‚¹ |
| `note.js` (å‰ç«¯) | æµå¼ API è°ƒç”¨å‡½æ•° |
| `publish.vue` (å‰ç«¯) | æ‰“å­—æœºæ•ˆæœå±•ç¤º |

---

## åç«¯é…ç½®è¯¦è§£

### AiModelConfig.java - æµå¼æ¨¡å‹é…ç½®

```java
@Configuration
public class AiModelConfig {

    // ... åŒæ­¥æ¨¡å‹é…ç½®ï¼ˆç•¥ï¼‰...

    /**
     * DeepSeek æµå¼èŠå¤©æ¨¡å‹ Bean
     * ç”¨äºå•†å®¶ç«¯çš„æµå¼ AI åŠŸèƒ½
     */
    @Bean
    @Primary
    public StreamingChatLanguageModel deepSeekStreamingChatModel() {
        log.info("åˆå§‹åŒ– DeepSeek æµå¼èŠå¤©æ¨¡å‹: {}", deepSeekModelName);

        return OpenAiStreamingChatModel.builder()
                .apiKey(deepSeekApiKey)
                .baseUrl(deepSeekBaseUrl)
                .modelName(deepSeekModelName)
                .temperature(deepSeekTemperature)
                .maxTokens(deepSeekMaxTokens)
                .timeout(Duration.ofSeconds(deepSeekTimeout))
                .logRequests(true)
                .logResponses(true)
                .build();
    }

    /**
     * é€šä¹‰åƒé—® Qwen-VL æµå¼è§†è§‰æ¨¡å‹ Bean
     * ç”¨äºç”¨æˆ·ç«¯çš„æ¢åº—ç¬”è®°æµå¼ç”Ÿæˆ
     */
    @Bean("visionStreamingChatModel")
    public StreamingChatLanguageModel visionStreamingChatModel() {
        log.info("åˆå§‹åŒ– é€šä¹‰åƒé—® Qwen-VL æµå¼è§†è§‰æ¨¡å‹: {}", qwenVisionModelName);

        return OpenAiStreamingChatModel.builder()
                .apiKey(qwenVisionApiKey)
                .baseUrl(qwenVisionBaseUrl)
                .modelName(qwenVisionModelName)
                .temperature(qwenVisionTemperature)
                .maxTokens(qwenVisionMaxTokens)
                .timeout(Duration.ofSeconds(qwenVisionTimeout))
                .logRequests(true)
                .logResponses(true)
                .build();
    }
}
```

### VisionNoteStreamServiceImpl.java - æµå¼æœåŠ¡

```java
@Slf4j
@Service
public class VisionNoteStreamServiceImpl implements VisionNoteStreamService {

    private final StreamingChatLanguageModel visionStreamingChatModel;

    public VisionNoteStreamServiceImpl(
            @Qualifier("visionStreamingChatModel") 
            StreamingChatLanguageModel visionStreamingChatModel) {
        this.visionStreamingChatModel = visionStreamingChatModel;
    }

    @Override
    public void generateNoteStream(NoteGenerateRequest request, SseEmitter emitter) {
        // 1. æ„å»ºæ¶ˆæ¯
        SystemMessage systemMessage = SystemMessage.from(SYSTEM_PROMPT);
        UserMessage userMessage = buildUserMessage(request);
        List<ChatMessage> messages = List.of(systemMessage, userMessage);

        // 2. è°ƒç”¨æµå¼æ¨¡å‹
        visionStreamingChatModel.generate(messages, new StreamingResponseHandler<>() {
            
            @Override
            public void onNext(String token) {
                try {
                    // æ¯ä¸ª token ä½œä¸º SSE äº‹ä»¶å‘é€
                    emitter.send(SseEmitter.event()
                            .name("token")
                            .data(Objects.requireNonNull(token)));
                } catch (IOException e) {
                    log.error("SSE å‘é€å¤±è´¥", e);
                    emitter.completeWithError(e);
                }
            }

            @Override
            public void onComplete(Response<AiMessage> response) {
                try {
                    // å‘é€å®Œæˆä¿¡å·
                    emitter.send(SseEmitter.event()
                            .name("done")
                            .data("[DONE]"));
                    emitter.complete();
                    log.info("æµå¼ç”Ÿæˆå®Œæˆ");
                } catch (IOException e) {
                    log.error("SSE å®Œæˆäº‹ä»¶å‘é€å¤±è´¥", e);
                }
            }

            @Override
            public void onError(Throwable error) {
                log.error("æµå¼ç”Ÿæˆå¤±è´¥", error);
                sendError(emitter, error.getMessage());
                emitter.completeWithError(error);
            }
        });
    }
}
```

### NoteAIController.java - SSE ç«¯ç‚¹

```java
@Slf4j
@RestController
@RequestMapping("/note")
@RequiredArgsConstructor
public class NoteAIController {

    private final VisionNoteStreamService visionNoteStreamService;
    private final ExecutorService executor = Executors.newCachedThreadPool();

    /**
     * AI æ™ºèƒ½ç”Ÿæˆæ¢åº—ç¬”è®°ï¼ˆSSE æµå¼ç‰ˆæœ¬ï¼‰
     * 
     * @produces text/event-stream
     */
    @PostMapping(value = "/generate/stream", 
                 produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public SseEmitter generateNoteStream(
            @RequestBody @Valid NoteGenerateRequest request) {
        
        log.info("æ”¶åˆ° AI æµå¼ç”Ÿæˆè¯·æ±‚");

        // åˆ›å»º SseEmitterï¼Œè¶…æ—¶æ—¶é—´ 3 åˆ†é’Ÿ
        SseEmitter emitter = new SseEmitter(180000L);

        // å¼‚æ­¥æ‰§è¡Œæµå¼ç”Ÿæˆ
        executor.execute(() -> 
            visionNoteStreamService.generateNoteStream(request, emitter));

        // è®¾ç½®å›è°ƒ
        emitter.onTimeout(() -> {
            log.warn("SSE è¿æ¥è¶…æ—¶");
            emitter.complete();
        });
        emitter.onCompletion(() -> log.info("SSE è¿æ¥å…³é—­"));
        emitter.onError(e -> log.error("SSE é”™è¯¯: {}", e.getMessage()));

        return emitter;
    }
}
```

---

## å‰ç«¯æ¥å…¥æŒ‡å—

### API å‡½æ•° - æµå¼è¯·æ±‚

```javascript
// api/note.js

/**
 * AI æ™ºèƒ½ç”Ÿæˆæ¢åº—ç¬”è®°ï¼ˆæµå¼ç‰ˆæœ¬ï¼‰
 * @param {Object} data - ç”Ÿæˆè¯·æ±‚
 * @param {Function} onToken - token å›è°ƒ
 * @param {Function} onComplete - å®Œæˆå›è°ƒ
 * @param {Function} onError - é”™è¯¯å›è°ƒ
 */
export const generateNoteByAIStream = async (
  data, onToken, onComplete, onError) => {
  
  const baseUrl = getBaseUrl()
  const token = uni.getStorageSync('token')
  
  try {
    const response = await fetch(`${baseUrl}/note/generate/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : ''
      },
      body: JSON.stringify(data)
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    // è¯»å–æµ
    const reader = response.body.getReader()
    const decoder = new TextDecoder('utf-8')
    let fullText = ''
    let buffer = ''

    while (true) {
      const { done, value } = await reader.read()
      if (done) break

      buffer += decoder.decode(value, { stream: true })
      
      // è§£æ SSE æ ¼å¼
      const lines = buffer.split('\n')
      buffer = lines.pop() || ''

      for (const line of lines) {
        if (line.startsWith('data:')) {
          const data = line.substring(5).trim()
          
          if (data === '[DONE]') {
            if (onComplete) onComplete(fullText)
            return
          }
          
          fullText += data
          if (onToken) onToken(data)
        }
      }
    }

    if (onComplete) onComplete(fullText)

  } catch (error) {
    console.error('SSE æµå¼ç”Ÿæˆå¤±è´¥:', error)
    if (onError) onError(error)
    throw error
  }
}
```

### ç»„ä»¶ä½¿ç”¨ - æ‰“å­—æœºæ•ˆæœ

```javascript
// publish.vue

const handleMagicGenerate = async () => {
  generating.value = true
  title.value = ''
  content.value = ''
  
  let fullText = ''
  let isParsingTitle = true
  
  await generateNoteByAIStream(
    generateRequest,
    
    // onToken: æ¯ä¸ª token åˆ°è¾¾
    (token) => {
      fullText += token
      
      // è§£ææ ‡é¢˜å’Œæ­£æ–‡ï¼ˆç”¨ --- åˆ†éš”ï¼‰
      if (isParsingTitle && fullText.includes('---')) {
        const parts = fullText.split('---')
        title.value = parts[0].trim()
        content.value = parts.slice(1).join('---').trim()
        isParsingTitle = false
      } else if (isParsingTitle) {
        title.value = fullText.trim()
      } else {
        const parts = fullText.split('---')
        content.value = parts.slice(1).join('---').trim()
      }
    },
    
    // onComplete: ç”Ÿæˆå®Œæˆ
    (finalText) => {
      // æœ€ç»ˆè§£æ
      if (finalText.includes('---')) {
        const parts = finalText.split('---')
        title.value = parts[0].trim()
        content.value = parts.slice(1).join('---').trim()
      }
      generating.value = false
      uni.showToast({ title: 'AIåˆ›ä½œå®Œæˆï¼', icon: 'success' })
    },
    
    // onError: é”™è¯¯å¤„ç†
    (error) => {
      generating.value = false
      uni.showToast({ title: error.message, icon: 'none' })
    }
  )
}
```

---

## SSE äº‹ä»¶åè®®

### äº‹ä»¶ç±»å‹å®šä¹‰

| äº‹ä»¶å | æ•°æ®æ ¼å¼ | è§¦å‘æ—¶æœº | è¯´æ˜ |
|--------|----------|----------|------|
| `token` | å­—ç¬¦ä¸² | æ¯ä¸ª token ç”Ÿæˆæ—¶ | AI ç”Ÿæˆçš„å†…å®¹ç‰‡æ®µ |
| `done` | `[DONE]` | å…¨éƒ¨ç”Ÿæˆå®Œæˆ | å®¢æˆ·ç«¯åº”å…³é—­è¿æ¥ |
| `error` | é”™è¯¯ä¿¡æ¯ | å‘ç”Ÿå¼‚å¸¸ | å®¢æˆ·ç«¯åº”æ˜¾ç¤ºé”™è¯¯ |

### SSE æ•°æ®æ ¼å¼

```
event: token
data: æ¢

event: token
data: åº—

event: token
data: ç¬”

event: token
data: è®°

...

event: done
data: [DONE]
```

### é”™è¯¯äº‹ä»¶

```
event: error
data: AI ç”Ÿæˆå¤±è´¥: æ¨¡å‹è¶…æ—¶

(è¿æ¥å…³é—­)
```

---

## æœ€ä½³å®è·µ

### âœ… åç«¯æ¨è

```java
// 1. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
SseEmitter emitter = new SseEmitter(180000L);  // 3åˆ†é’Ÿ

// 2. å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ Tomcat çº¿ç¨‹
executor.execute(() -> streamService.generate(request, emitter));

// 3. å®Œå–„çš„å›è°ƒå¤„ç†
emitter.onTimeout(() -> emitter.complete());
emitter.onCompletion(() -> log.info("è¿æ¥å…³é—­"));
emitter.onError(e -> log.error("é”™è¯¯", e));

// 4. ä½¿ç”¨ Objects.requireNonNull å¤„ç† null
emitter.send(SseEmitter.event()
        .name("token")
        .data(Objects.requireNonNull(token)));
```

### âœ… å‰ç«¯æ¨è

```javascript
// 1. æä¾›å–æ¶ˆåŠŸèƒ½
const abortController = new AbortController()
fetch(url, { signal: abortController.signal })

// å–æ¶ˆç”Ÿæˆ
onCancel() {
  abortController.abort()
}

// 2. æ˜¾ç¤ºç”ŸæˆçŠ¶æ€
<view v-if="generating" class="generating-indicator">
  <text>AI æ­£åœ¨åˆ›ä½œ...</text>
</view>

// 3. ä¼˜é›…çš„é”™è¯¯å¤„ç†
onError: (error) => {
  if (error.name === 'AbortError') {
    // ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆï¼Œä¸æ˜¾ç¤ºé”™è¯¯
    return
  }
  uni.showToast({ title: 'AI ç”Ÿæˆå¤±è´¥', icon: 'none' })
}
```

### âŒ é¿å…çš„åšæ³•

```java
// 1. ä¸è¦åœ¨ä¸»çº¿ç¨‹åŒæ­¥æ‰§è¡Œ
@PostMapping("/generate/stream")
public SseEmitter generate() {
    SseEmitter emitter = new SseEmitter();
    streamService.generate(emitter);  // âŒ é˜»å¡
    return emitter;
}

// 2. ä¸è¦å¿˜è®°å¤„ç†è¶…æ—¶
SseEmitter emitter = new SseEmitter();  // âŒ é»˜è®¤ 30 ç§’è¶…æ—¶ï¼ŒAI å¯èƒ½æ›´ä¹…
```

---

## éƒ¨ç½²é…ç½®

### Nginx åå‘ä»£ç†é…ç½®

SSE éœ€è¦ç¦ç”¨å“åº”ç¼“å†²ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å®¹ä¸€æ¬¡æ€§å‘é€ï¼š

```nginx
location /api/note/generate/stream {
    proxy_pass http://backend;
    
    # SSE å…³é”®é…ç½®
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    
    # ç¦ç”¨ç¼“å†²
    proxy_buffering off;
    proxy_cache off;
    
    # åˆ†å—ä¼ è¾“
    chunked_transfer_encoding on;
    
    # è¶…æ—¶è®¾ç½®ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰
    proxy_read_timeout 180s;
    proxy_send_timeout 180s;
}

location /api/merchant/reply/generate/stream {
    # åŒä¸Šé…ç½®
}
```

### Spring Boot é…ç½®

```yaml
# application.yml
server:
  # å¼‚æ­¥è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  servlet:
    async:
      timeout: 180000  # 3åˆ†é’Ÿ

spring:
  mvc:
    async:
      request-timeout: 180000
```

---

## å¸¸è§é—®é¢˜

### 1. å‰ç«¯æ”¶ä¸åˆ°æµå¼æ•°æ®ï¼Ÿ

```
æ£€æŸ¥æ¸…å•ï¼š
â–¡ Nginx æ˜¯å¦ç¦ç”¨äº† proxy_bufferingï¼Ÿ
â–¡ CDN æ˜¯å¦å¯ç”¨äº†å“åº”ç¼“å†²ï¼Ÿ
â–¡ åç«¯ SseEmitter è¶…æ—¶è®¾ç½®æ˜¯å¦è¶³å¤Ÿï¼Ÿ
â–¡ Content-Type æ˜¯å¦ä¸º text/event-streamï¼Ÿ
```

### 2. è¿æ¥é¢‘ç¹è¶…æ—¶ï¼Ÿ

```java
// å¢åŠ è¶…æ—¶æ—¶é—´
SseEmitter emitter = new SseEmitter(300000L);  // 5åˆ†é’Ÿ

// æ£€æŸ¥ AI æ¨¡å‹ timeout é…ç½®
OpenAiStreamingChatModel.builder()
    .timeout(Duration.ofSeconds(120))  // å¢åŠ 
    .build();
```

### 3. UniApp å°ç¨‹åºä¸æ”¯æŒ fetchï¼Ÿ

```javascript
// å°ç¨‹åºç¯å¢ƒä½¿ç”¨ uni.request æ¨¡æ‹Ÿï¼ˆä¸æ¨èï¼‰
// å»ºè®®ï¼šå°ç¨‹åºç¯å¢ƒé™çº§ä½¿ç”¨åŒæ­¥æ¥å£

// #ifdef MP
// å°ç¨‹åºä½¿ç”¨åŒæ­¥æ¥å£
const result = await generateNoteByAI(request)
// #endif

// #ifdef H5
// H5 ä½¿ç”¨æµå¼æ¥å£
await generateNoteByAIStream(request, onToken, onComplete, onError)
// #endif
```

### 4. å¦‚ä½•å®ç°è¿›åº¦ç™¾åˆ†æ¯”ï¼Ÿ

```javascript
// AI ç”Ÿæˆé•¿åº¦ä¸ç¡®å®šï¼Œæ— æ³•ç²¾ç¡®è®¡ç®—ç™¾åˆ†æ¯”
// å¯ä»¥ä½¿ç”¨æ¨¡ç³Šè¿›åº¦

let charCount = 0
onToken: (token) => {
  charCount += token.length
  // å‡è®¾é¢„æœŸé•¿åº¦ä¸º 300 å­—
  const progress = Math.min(charCount / 300 * 100, 95)
  progressBar.value = progress
}

onComplete: () => {
  progressBar.value = 100
}
```

---

## æ€»ç»“

é€šè¿‡å®ç° SSE æµå¼ AI å“åº”ï¼Œæˆ‘ä»¬æ˜¾è‘—æå‡äº†ç”¨æˆ·ä½“éªŒï¼š

| ç›®æ ‡ | å®ç°æ•ˆæœ |
|------|----------|
| å³æ—¶åé¦ˆ | é¦–å­— 1-2 ç§’æ˜¾ç¤º |
| äº¤äº’ä½“éªŒ | æ‰“å­—æœºæ•ˆæœï¼Œä»¿ä½› AI åœ¨"æ€è€ƒ" |
| å¯æ§æ€§ | æ”¯æŒä¸­é€”å–æ¶ˆ |
| æŠ€æœ¯å®ç° | åŸºäº Spring SseEmitter + LangChain4j |

### æ¥å£æ¸…å•

| åŠŸèƒ½ | åŒæ­¥æ¥å£ | æµå¼æ¥å£ |
|------|----------|----------|
| ç”¨æˆ·ç¬”è®°ç”Ÿæˆ | `POST /note/generate` | `POST /note/generate/stream` |
| å•†å®¶æ™ºèƒ½å›å¤ | `POST /merchant/reply/generate` | `POST /merchant/reply/generate/stream` |

è¿™å¥—æ–¹æ¡ˆä½¿ AI å†…å®¹ç”Ÿæˆçš„ç”¨æˆ·ä½“éªŒæå‡åˆ°ä¸ä¸»æµ AI äº§å“ï¼ˆå¦‚ ChatGPTï¼‰åŒç­‰æ°´å¹³ã€‚
