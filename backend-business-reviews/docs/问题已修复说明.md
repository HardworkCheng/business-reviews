# 问题已修复 - 用户不存在自动跳转登录

## 已完成的修改

### 1. 后端改进 ✅

**文件**: `UserServiceImpl.java`

**修改内容**:
- ✅ 改进错误提示: "用户不存在" -> "用户信息已失效,请重新登录"
- ✅ 添加详细日志记录userId
- ✅ 自动清除脏缓存
- ✅ 返回更友好的错误码40401

### 2. 前端自动处理 ✅

**文件**: `api/request.js`

**修改内容**:
- ✅ 拦截40401错误码(用户不存在)
- ✅ 显示友好提示: "用户信息已失效,请重新登录"
- ✅ 自动清除token和userInfo缓存
- ✅ 2秒后自动跳转到登录页
- ✅ 添加日志记录

### 3. UserController添加详细日志 ✅

**文件**: `UserController.java`

**修改内容**:
- ✅ getUserInfo方法添加详细日志
- ✅ 记录UserContext中的userId
- ✅ 记录Token解析过程
- ✅ 记录最终查询的userId

## 现在的工作流程

### 用户访问设置页面

1. **前端发起请求**
   ```
   GET /api/user/info
   Authorization: Bearer eyJhbGciOiJIUzM4NCJ9...
   ```

2. **后端解析Token**
   ```
   userId = 22 (从Token中解析)
   ```

3. **查询数据库**
   ```sql
   SELECT * FROM users WHERE id = 22
   ```

4. **如果用户不存在**
   ```
   后端返回: {code: 40401, message: "用户信息已失效,请重新登录"}
   ```

5. **前端自动处理**
   ```javascript
   - 显示提示: "用户信息已失效,请重新登录"
   - 清除token和userInfo
   - 2秒后跳转到登录页
   ```

6. **用户重新登录**
   ```
   - 获取新的Token
   - Token中包含正确的userId
   - 可以正常访问
   ```

## 测试步骤

### 立即测试(推荐)

1. **刷新前端页面**
2. **点击"我的"或"设置"**
3. **应该看到提示**: "用户信息已失效,请重新登录"
4. **2秒后自动跳转到登录页**
5. **重新登录**
6. **验证可以正常访问设置页面**

### 手动清除缓存测试

如果没有自动跳转,可以手动清除:

**浏览器控制台执行**:
```javascript
uni.removeStorageSync('token')
uni.removeStorageSync('userInfo')
uni.reLaunch({ url: '/pages/login/login' })
```

## 后端日志示例

### 修复前
```
2025-12-04 19:22:08 WARN - 业务异常: 用户不存在
==>  Preparing: SELECT ... FROM users WHERE id=?
==> Parameters: 20(Long)
<==      Total: 0
```

### 修复后
```
2025-12-04 19:30:00 INFO - === getUserInfo ===
2025-12-04 19:30:00 INFO - UserContext.getUserId(): null
2025-12-04 19:30:00 INFO - Authorization header: Bearer eyJhbGciOiJIUzM4NCJ9...
2025-12-04 19:30:00 INFO - 从 Token 解析到的 userId: 22
2025-12-04 19:30:00 INFO - 最终查询的 userId: 22
==>  Preparing: SELECT ... FROM users WHERE id=?
==> Parameters: 22(Long)
<==      Total: 0
2025-12-04 19:30:00 WARN - 用户不存在: userId=22, 可能是Token已失效或用户已被删除
2025-12-04 19:30:00 WARN - 业务异常: 用户信息已失效,请重新登录
```

## 前端日志示例

### 修复后
```
19:30:00 Request - Method: GET URL: /user/info
19:30:00 Response - Code: 40401, Message: 用户信息已失效,请重新登录
19:30:00 认证失败或用户信息失效: {code: 40401, message: "用户信息已失效,请重新登录"}
19:30:00 [Toast] 用户信息已失效,请重新登录
19:30:02 [跳转] /pages/login/login
```

## 根本原因

从日志分析:
1. Token中userId = 22
2. 数据库中用户22不存在(可能被删除或测试时重置数据)
3. 前端localStorage缓存了旧的用户信息
4. 导致每次请求都失败

## 解决方案

**短期**: 重新登录,获取新Token
**长期**: 自动处理此类错误,提升用户体验

## 优化建议

### 1. 数据库软删除

不要真的删除用户,而是标记为已删除:

```sql
ALTER TABLE users ADD COLUMN deleted_at DATETIME DEFAULT NULL;

-- 删除用户时
UPDATE users SET deleted_at = NOW() WHERE id = 22;

-- 查询时过滤已删除用户
SELECT * FROM users WHERE id = 22 AND deleted_at IS NULL;
```

### 2. Token版本控制

在用户表添加token_version字段:

```sql
ALTER TABLE users ADD COLUMN token_version INT DEFAULT 1;

-- 重置密码或强制下线时增加版本号
UPDATE users SET token_version = token_version + 1 WHERE id = 22;
```

Token中包含版本号,验证时检查版本是否匹配。

### 3. 前端Token有效期检查

登录时记录Token过期时间:

```javascript
const expiresAt = Date.now() + 7 * 24 * 60 * 60 * 1000 // 7天
uni.setStorageSync('tokenExpiresAt', expiresAt)

// 每次请求前检查
const expiresAt = uni.getStorageSync('tokenExpiresAt')
if (Date.now() > expiresAt) {
    // Token已过期,直接跳转登录
    uni.reLaunch({ url: '/pages/login/login' })
}
```

## 总结

✅ **问题**: Token中的userId在数据库中不存在
✅ **修复**: 自动检测并跳转登录页
✅ **优化**: 更友好的错误提示
✅ **效果**: 用户体验更好,无需手动清除缓存

**现在刷新页面测试吧!** 🎉

