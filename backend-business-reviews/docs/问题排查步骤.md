# 用户信息设置功能问题排查步骤

## 问题描述
1. 点击生日、个人简介等没有弹出编辑框
2. 点击保存时报错 "用户未登录"

## 已修复的问题

### 1. 编辑框无法弹出
**原因**: `uni.showModal` 的 `editable` 参数在H5平台不支持

**解决方案**:
- 简化了编辑流程,直接使用 `uni.showModal` 的 `editable` 参数
- 添加了日期格式验证
- 改进了性别选择逻辑,避免重复设置

**影响的文件**:
- `pages/settings/settings.vue`

### 2. 保存失败 "用户未登录"
**可能原因**:
1. Token 未正确存储
2. Token 格式不正确
3. Token 已过期
4. 请求头未正确携带 token

**已添加的调试**:
- 在 `request.js` 中增加了详细的日志输出
- 在 `settings.vue` 的 `onLoad` 中检查 token 是否存在
- 在 `handleSave` 中检查 token 是否存在

## 排查步骤

### 步骤1: 检查是否已登录
1. 打开浏览器控制台(F12)
2. 查看 Application > Local Storage
3. 检查是否有 `token` 和 `userInfo` 数据

**预期结果**:
```
token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
userInfo: {...用户信息对象...}
```

**如果没有token**:
- 说明没有登录或登录失败
- 返回登录页面重新登录

### 步骤2: 检查控制台日志
进入设置页面时,应该看到:

```
Settings onLoad - token: eyJhbGciOiJIUzI1NiIsInR5...
开始请求用户信息...
Request - Method: GET URL: /user/info , Token: eyJhbGciOiJIUzI1NiIsInR5...
Request - Authorization header added: Bearer eyJhbGciOiJIUzI1NiIsInR5...
Request - Full URL: http://localhost:8080/api/user/info
Request - Headers: {"Content-Type":"application/json","Authorization":"Bearer eyJ..."}
Response - URL: /user/info , Code: 200 , Message: success
用户信息响应: {...}
```

**如果看到**:
- "无token" - 说明没有登录,需要重新登录
- "Code: 401" - 说明 token 已过期或无效,需要重新登录
- "用户未登录" - 说明后端没有收到 token 或 token 解析失败

### 步骤3: 测试编辑功能
1. 点击"用户名"项
2. 应该弹出输入框,有标题"修改用户名"
3. 输入新的用户名
4. 点击确定
5. 应该提示"用户名已更新,请保存"

**如果没有弹出框**:
- 检查是否使用的是最新代码
- 尝试清除缓存重新加载

### 步骤4: 测试保存功能
1. 修改任意信息(如用户名)
2. 点击"保存修改"按钮
3. 查看控制台日志

**正常流程日志**:
```
开始保存,token: eyJhbGciOiJIUzI1NiIsInR5...
更新数据: {username: "新用户名", avatar: "...", ...}
Request - Method: PUT URL: /user/info , Token: eyJhbGciOiJIUzI1NiIsInR5...
Request - Authorization header added: Bearer eyJhbGciOiJIUzI1NiIsInR5...
Request - Full URL: http://localhost:8080/api/user/info
Response - URL: /user/info , Code: 200 , Message: 更新成功
```

**如果失败**:
- 查看 Response Code
- 查看错误消息
- 检查后端日志

### 步骤5: 检查后端日志
如果前端显示 "用户未登录",查看后端控制台:

**正常日志应该包含**:
```
Request - Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5...
Token validated, userId: 1
```

**如果看到**:
```
java.lang.RuntimeException: 用户未登录
	at com.businessreviews.context.UserContext.requireUserId(UserContext.java:21)
```

这说明拦截器没有正确设置 userId,可能原因:
1. Token 格式错误(不是 "Bearer " 开头)
2. Token 验证失败
3. Token 在黑名单中
4. 拦截器没有正确执行

## 解决方案

### 方案1: 重新登录
最简单的方法:
1. 点击"退出登录"
2. 重新登录
3. 进入设置页面
4. 修改信息并保存

### 方案2: 检查后端配置
1. 确认 `AuthInterceptor` 是否正确配置
2. 确认 `/api/user/**` 路径需要认证
3. 确认 JWT 密钥配置正确
4. 确认 Redis 连接正常

### 方案3: 检查前端配置
1. 确认 `BASE_URL` 配置正确(http://localhost:8080/api)
2. 确认 token 存储使用 `uni.setStorageSync('token', ...)`
3. 确认请求头正确添加 Authorization

## 测试检查清单

- [ ] 可以正常登录
- [ ] 登录后 localStorage 中有 token
- [ ] 进入设置页面能看到用户信息
- [ ] 点击用户名能弹出编辑框
- [ ] 点击性别能弹出选择器
- [ ] 点击生日能弹出输入框
- [ ] 点击个人简介能弹出编辑框
- [ ] 修改后显示"已更新,请保存"
- [ ] 点击保存按钮显示"保存中..."
- [ ] 保存成功显示"保存成功"
- [ ] 返回个人中心,信息已更新
- [ ] 刷新页面,信息保持不变
- [ ] 数据库中数据已更新

## 常见错误及解决

### 错误1: "登录已过期,请重新登录"
**原因**: Token 已过期
**解决**: 重新登录

### 错误2: "网络请求失败"
**原因**: 后端服务未启动或 URL 配置错误
**解决**: 
- 检查后端是否启动(http://localhost:8080)
- 检查 `api/request.js` 中的 BASE_URL

### 错误3: "用户未登录"
**原因**: Token 未正确传递到后端
**解决**:
- 查看控制台日志,确认 Authorization 头是否添加
- 查看后端日志,确认是否收到 token
- 重新登录获取新 token

### 错误4: "日期格式错误"
**原因**: 生日格式不正确
**解决**: 使用 YYYY-MM-DD 格式,例如: 1990-01-01

## 调试技巧

### 1. 查看请求详情
在浏览器 Network 标签中:
- 找到 `/user/info` 的 PUT 请求
- 查看 Headers 中是否有 Authorization
- 查看 Request Payload 数据是否正确
- 查看 Response 返回的错误信息

### 2. 查看 Storage
在 Application > Local Storage 中:
- token 应该是长字符串(JWT格式)
- userInfo 应该包含所有用户信息

### 3. 清除缓存
如果遇到奇怪的问题:
```javascript
// 在控制台执行
uni.clearStorageSync()
```
然后重新登录

## 完整测试流程

1. **启动服务**
   - 启动后端服务
   - 启动前端服务

2. **登录**
   - 使用手机号验证码登录
   - 检查 localStorage 中的 token

3. **进入设置**
   - 点击"我的" > "设置"
   - 查看用户信息是否正确显示

4. **修改信息**
   - 修改用户名: "测试用户123"
   - 修改性别: "男"
   - 修改生日: "1990-05-20"
   - 修改简介: "这是我的新简介"

5. **保存**
   - 点击"保存修改"
   - 等待"保存成功"提示

6. **验证**
   - 返回个人中心
   - 检查信息是否更新
   - 查看数据库确认数据已保存

```sql
SELECT * FROM users WHERE id = {你的用户ID};
```

## 需要的前置条件

1. ✅ 后端服务已启动(端口 8080)
2. ✅ MySQL 数据库已启动
3. ✅ Redis 服务已启动
4. ✅ 前端项目已启动
5. ✅ 已经成功登录系统

如果以上任何一项不满足,请先完成相应的配置。
