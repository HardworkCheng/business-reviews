 
# 项目分析文档

## 1. 项目概览
- 项目定位：美食点评系统后端 API，支持移动端（UniApp）与商家运营中心。
- 架构风格：分层 + 多模块 Maven，统一启动入口。
- 运行入口：`backend-business-reviews-web` 模块。
- API 路径：统一 `context-path` 为 `/api`，商家端路径以 `/merchant/**` 进行区分。

## 2. 模块与分层结构
- `backend-business-reviews-common`：公共能力（常量、工具、统一响应、异常、WebSocket 支撑等）。
- `backend-business-reviews-entity`：数据模型（DO/DTO/VO），含 Converter 适配前后端字段。
- `backend-business-reviews-mapper`：MyBatis-Plus Mapper 层。
- `backend-business-reviews-manager`：第三方能力封装（OSS、短信）。
- `backend-business-reviews-service`：业务逻辑与 AI 能力实现。
- `backend-business-reviews-web`：Controller、配置、拦截器与启动类。

## 3. 技术栈与核心中间件
- 核心框架：Spring Boot 3.2、Spring MVC。
- ORM：MyBatis-Plus 3.5.5（逻辑删除、分页、Mapper 注解 SQL）。
- 存储：MySQL 8、Redis、Druid 连接池。
- 安全认证：JWT（JJWT 0.12.3）。
- 第三方：阿里云 OSS、阿里云短信（目前短信为模拟发送）。
- AI 能力：LangChain4j + DeepSeek/Qwen-VL，配套 Fastjson2 解析。

## 4. 主要业务能力
- 用户体系：验证码登录/密码登录/退出登录、用户信息管理。
- 笔记体系：发布、推荐、详情、互动。
- 商家体系：商家运营中心 API，含评论管理、优惠券、数据看板等。
- 评论体系：笔记评论、商家评价与回复。
- 消息体系：私信会话、通知、未读统计。
- 优惠券体系：普通优惠券 + 简化秒杀活动。

## 5. 认证与鉴权设计
- App 端：`AuthInterceptor` 校验 JWT + Redis 黑名单；对部分只读接口支持“可选鉴权”。
- 商家端：`MerchantAuthInterceptor` 校验 JWT，并从 `merchants` 表查询状态。
- 统一拦截策略：`/merchant/**` 走商家拦截器，其他路径走用户拦截器。

## 6. 消息与 WebSocket
- 私信消息：服务层在落库后通过 WebSocket 推送给接收方。
- WebSocket 处理：当前通过 URL query 参数传入 `userId` 进行 session 绑定。
- 配置存在两套注册（common 与 web 模块均注册），路径分别是 `/ws` 与 `/api/ws`。

## 7. AI 能力概览
- 智能回复：差评/好评自动识别与生成回复（DeepSeek）。
- 评论分析：生成周报（情感分数、优缺点、建议）。
- 探店笔记：多模态图文生成（Qwen-VL）。
- 内容审核：调用 AI 进行违规判定，异常时降级为“放行并提示人工复核”。

## 8. 风险与改进建议
1) 配置泄露风险  
   - `application.yml` 中包含数据库密码、JWT 密钥、Redis 密码、AI Key 等明文默认值。  
   - 建议：全部外置为环境变量，移除默认值；生产环境分离配置。

2) WebSocket 鉴权不足  
   - 当前仅依赖 URL `userId` 参数，缺少 Token 校验，存在伪造风险。  
   - 建议：在握手阶段校验 JWT，并将用户 ID 从 Token 解析后绑定。

3) WebSocket 路径重复  
   - common 与 web 两处配置同时注册 handler，实际路径可能混乱。  
   - 建议：保留单一配置与统一路径，避免 `/api/api/ws` 类问题。

4) 秒杀并发安全不足  
   - 目前使用 `synchronized`，多实例下存在超卖风险。  
   - 建议：数据库原子扣减或 Redis 分布式锁。

5) 日志敏感信息  
   - `AuthInterceptor` 会打印 Token；AI 模型开启请求/响应日志。  
   - 建议：脱敏日志，生产环境关闭 AI 请求日志。

6) 测试覆盖缺失  
   - 未发现 `src/test/java` 测试用例。  
   - 建议：先补关键路径（登录、发布、评论、消息、优惠券、AI 接口）的集成测试。

## 9. 结论
- 后端整体分层清晰、模块职责明确，AI 功能覆盖面广。  
- 需要重点加强安全配置与鉴权流程、WebSocket 设计一致性与并发控制。  
- 建议优先处理配置安全、WebSocket 鉴权、秒杀并发三类高风险问题。
