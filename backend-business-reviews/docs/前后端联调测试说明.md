# 前后端联调测试说明 - 用户信息设置功能

## 📋 功能概述
实现了完整的用户信息设置功能,包括:
- 个人信息编辑(头像、用户名、性别、生日、个人简介)
- 第三方账号绑定管理(微信、QQ、微博)
- 数据持久化到数据库
- 前后端完整联调

## 🔧 后端改动

### 1. UpdateUserInfoRequest.java
**文件路径**: `backend-business-reviews/src/main/java/com/businessreviews/dto/request/UpdateUserInfoRequest.java`

**改动内容**:
- 新增 `wechatOpenid` 字段 - 微信OpenID
- 新增 `qqOpenid` 字段 - QQ OpenID  
- 新增 `weiboUid` 字段 - 微博UID

### 2. UserInfoResponse.java
**文件路径**: `backend-business-reviews/src/main/java/com/businessreviews/dto/response/UserInfoResponse.java`

**改动内容**:
- 新增 `wechatOpenid` 字段
- 新增 `qqOpenid` 字段
- 新增 `weiboUid` 字段

### 3. UserServiceImpl.java
**文件路径**: `backend-business-reviews/src/main/java/com/businessreviews/service/impl/UserServiceImpl.java`

**改动内容**:
- `getUserInfo()` 方法: 返回第三方账号绑定信息
- `updateUserInfo()` 方法: 支持更新第三方账号绑定信息

## 🎨 前端改动

### 1. settings.vue (设置页面)
**文件路径**: `front-business-reviews-Mobile/pages/settings/settings.vue`

**新增功能**:
- ✅ 头像选择(拍照/相册)
- ✅ 用户名编辑
- ✅ 性别选择(保密/男/女)
- ✅ 生日输入
- ✅ 个人简介编辑
- ✅ 手机号显示(脱敏)
- ✅ 第三方账号绑定/解绑
- ✅ 保存按钮(调用后端API)
- ✅ 退出登录功能

**核心逻辑**:
- 修改检测: 对比原始数据和当前数据
- 数据保存: 调用 `updateUserInfo` API
- 缓存更新: 保存成功后更新本地缓存

### 2. user.js (API接口)
**文件路径**: `front-business-reviews-Mobile/api/user.js`

**改动内容**:
- 更新 `updateUserInfo` 接口注释,增加第三方账号字段说明

### 3. profile.vue (个人中心)
**改动内容**:
- 设置按钮点击跳转到设置页面
- `onShow` 生命周期自动刷新用户信息

### 4. pages.json (路由配置)
**改动内容**:
- 新增 `pages/settings/settings` 路由

## 🧪 测试步骤

### 步骤1: 启动后端服务
```bash
cd backend-business-reviews
# 确保数据库已启动
# 运行SpringBoot应用
```

### 步骤2: 启动前端应用
```bash
cd front-business-reviews-Mobile
npm install
npm run dev:h5  # 或其他平台命令
```

### 步骤3: 登录系统
1. 打开应用,进入登录页面
2. 使用手机号验证码登录
3. 登录成功后进入首页

### 步骤4: 进入设置页面
1. 点击底部导航栏"我的"
2. 点击右上角⚙️设置图标
3. 进入设置页面

### 步骤5: 测试信息修改
#### 5.1 修改用户名
- 点击"用户名"项
- 输入新的用户名
- 确认后提示"用户名已更新,请保存"

#### 5.2 修改性别
- 点击"性别"项
- 选择性别(保密/男/女)
- 确认后提示"性别已更新,请保存"

#### 5.3 修改生日
- 点击"生日"项
- 输入日期(格式: YYYY-MM-DD)
- 确认后提示"生日已更新,请保存"

#### 5.4 修改个人简介
- 点击"个人简介"项
- 输入新的简介内容
- 确认后提示"简介已更新,请保存"

#### 5.5 修改头像
- 点击"头像"项
- 选择"拍照"或"从相册选择"
- 选择图片后提示"头像已更新,请保存"

### 步骤6: 保存修改
1. 点击"保存修改"按钮
2. 显示"保存中..."加载提示
3. 保存成功后显示"保存成功"提示

### 步骤7: 验证数据持久化
#### 7.1 前端验证
- 返回个人中心页面
- 检查用户信息是否已更新

#### 7.2 数据库验证
```sql
-- 查询用户信息
SELECT id, username, avatar, bio, gender, birthday, 
       wechat_openid, qq_openid, weibo_uid
FROM users 
WHERE id = {用户ID};
```

#### 7.3 重新登录验证
- 退出登录
- 重新登录
- 进入个人中心,检查信息是否保持

### 步骤8: 测试退出登录
1. 在设置页面点击"退出登录"
2. 确认退出对话框
3. 验证:
   - 跳转到登录页面
   - 本地token已清除
   - 本地userInfo已清除

## 🔍 接口测试

### 获取用户信息
```
GET /user/info
Headers: 
  Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": "1",
    "username": "测试用户",
    "avatar": "https://...",
    "bio": "这是我的个人简介",
    "phone": "136****2199",
    "gender": 1,
    "birthday": "1990-01-01",
    "wechatOpenid": "",
    "qqOpenid": "",
    "weiboUid": "",
    "followingCount": 10,
    "followerCount": 20,
    "likeCount": 100,
    "favoriteCount": 50,
    "noteCount": 15
  }
}
```

### 更新用户信息
```
PUT /user/info
Headers:
  Authorization: Bearer {token}
  Content-Type: application/json

Body:
{
  "username": "新用户名",
  "avatar": "https://new-avatar.jpg",
  "bio": "新的个人简介",
  "gender": 1,
  "birthday": "1990-01-01",
  "wechatOpenid": "",
  "qqOpenid": "",
  "weiboUid": ""
}

Response:
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

### 退出登录
```
POST /auth/logout
Headers:
  Authorization: Bearer {token}

Response:
{
  "code": 200,
  "message": "success",
  "data": null
}
```

## ⚠️ 注意事项

### 1. 数据验证
- 用户名长度: 2-20个字符
- 个人简介: 最多100个字符
- 性别: 0(保密)、1(男)、2(女)
- 生日格式: YYYY-MM-DD

### 2. 权限验证
- 所有接口需要登录(携带token)
- token过期会自动跳转登录页

### 3. 图片上传
- 头像选择后获得临时路径
- 实际项目中需要上传到服务器或OSS
- 当前测试可使用临时路径

### 4. 第三方账号绑定
- 当前为解绑功能演示
- 实际绑定需要对接第三方OAuth
- 空字符串表示未绑定

### 5. 缓存策略
- 用户信息缓存在Redis(30分钟)
- 更新后会清除缓存
- 前端本地缓存同步更新

## 🐛 常见问题

### Q1: 保存失败,提示网络错误
**解决方案**:
- 检查后端服务是否启动
- 检查前端API baseURL配置
- 查看浏览器控制台网络请求

### Q2: 修改后返回个人中心没有更新
**解决方案**:
- 检查profile.vue的onShow是否执行
- 检查是否调用了fetchUserInfo
- 清除应用缓存重试

### Q3: 图片选择后无法保存
**解决方案**:
- 确认图片已成功选择
- 检查avatar字段是否正确传递
- 实际项目需要先上传图片获取URL

### Q4: 退出登录后仍可访问其他页面
**解决方案**:
- 检查AuthInterceptor拦截器配置
- 确认token已清除
- 检查前端路由守卫

## ✅ 验收标准

### 功能完整性
- [x] 所有字段都可以编辑
- [x] 修改后可以保存到数据库
- [x] 保存成功后前端显示更新
- [x] 刷新页面数据保持
- [x] 退出登录功能正常

### 用户体验
- [x] 操作有Loading提示
- [x] 成功/失败有明确反馈
- [x] 页面切换流畅
- [x] 数据展示清晰

### 数据安全
- [x] 手机号脱敏显示
- [x] 接口需要登录认证
- [x] 退出后清除敏感信息

## 📝 后续优化建议

1. **图片上传**: 集成OSS或本地文件上传服务
2. **日期选择器**: 使用uni-app的picker组件优化生日选择
3. **表单验证**: 添加更严格的前端验证(手机号、邮箱等)
4. **第三方绑定**: 实现完整的OAuth登录和绑定流程
5. **修改记录**: 记录用户信息修改历史
6. **敏感操作**: 重要信息修改需要验证码确认
