# 全场景智能回复助手 - 功能文档

## 功能概述

本功能使用 LangChain4j 框架对接 DeepSeek 大语言模型，实现**全场景用户评论智能回复**。AI 会自动识别用户评论是"好评"还是"差评"，并采用完全不同的回复策略：

- **好评**：热情、感激、俏皮，重在"建立连接"和"鼓励复购"
- **差评**：诚恳、安抚、专业，重在"安抚情绪"和"挽回流失"

## 技术栈

- **框架**: Spring Boot 3.x
- **AI 框架**: LangChain4j 0.36.2
- **LLM 提供商**: DeepSeek (使用 OpenAI 兼容 API)

## API 接口

### 智能生成回复

**请求路径**: `POST /merchant/reply/generate`

**请求头**:
```
Authorization: Bearer <jwt_token>
Content-Type: application/json
```

**请求体**:
```json
{
    "reviewText": "味道太赞了，尤其是干锅鸡！",
    "strategy": "送饮料券"
}
```

**参数说明**:
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| reviewText | String | 是 | 用户的评论内容（好评或差评均可） |
| strategy | String | 否 | 商家的赠礼策略，好评时是"惊喜回馈"，差评时是"表达歉意" |

**响应示例 - 好评场景**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "reply": "哇！看到同学这么喜欢我们的干锅鸡，老板简直开心得想转圈圈！🥰 您的认可是我们最大的动力！为了感谢您的支持，下次来吃饭送您一张饮料券哦 🥤，期待您带朋友常来！",
        "generatedAt": "2024-12-28 23:50:00"
    }
}
```

**响应示例 - 差评场景**:
```json
{
    "code": 200,
    "message": "success",
    "data": {
        "reply": "非常抱歉给您带来不好的体验！😔 让您饿着肚子等了这么久，不仅是身体难受，心情肯定也受影响，真是对不起。我们已经在这个问题上狠狠批评了后厨。为了表达歉意，送您一张饮料券，希望能消消气，给我们一个改进的机会！🙏",
        "generatedAt": "2024-12-28 23:50:00"
    }
}
```

## AI Prompt 设计（思维链）

### 核心思路：条件生成 (Conditioning Generation)

不使用额外的 NLP 库判断好评差评，而是让**大模型自己判断**，更灵活、更自然。

### 思维链步骤

**第一步：情感判断**
- AI 分析用户评论的情感倾向
- 判断是"好评/正面"还是"差评/负面"

**第二步：选择回复策略**

| 场景 | 语气 | Emoji | 赠礼语境 |
|------|------|-------|----------|
| ★ 好评 | 开心、激动、感激、俏皮 | 🥰 ❤️ 🎉 😊 | "惊喜回馈、感谢礼物" |
| ★ 差评 | 诚恳、严肃、抱歉、温暖 | 😔 😭 🙏 | "补偿、表达歉意" |

### 好评回复结构
1. 表达开心和感谢
2. 复述并认可用户夸奖的点
3. 赠礼作为"惊喜回馈"送出（如有）
4. 热情期待再次光临，鼓励带朋友来

### 差评回复结构
1. 真诚致歉
2. 共情用户的不满（复述问题）
3. 说明改进措施
4. 赠礼作为"补偿/表达歉意"送出（如有）
5. 再次致歉并希望能挽回

### 重要约束
- 回复字数控制在 **100-150 字**
- 使用亲切称呼（亲、同学）
- 赠礼策略的语境必须正确转换
- 如果没有赠礼策略，不要编造任何优惠承诺
- 中性评论可以灵活处理

## 代码结构

```
backend-business-reviews/
├── backend-business-reviews-entity/
│   └── src/main/java/com/businessreviews/model/
│       ├── dto/ai/
│       │   └── GenerateReplyDTO.java       # 请求 DTO
│       └── vo/ai/
│           └── GenerateReplyVO.java        # 响应 VO
│
├── backend-business-reviews-service/
│   └── src/main/java/com/businessreviews/service/
│       ├── ai/
│       │   ├── SmartReplyAgent.java        # 全场景智能回复 AI 接口 (新)
│       │   ├── ReviewReplyAgent.java       # 差评回复 AI 接口 (旧，保留)
│       │   └── ReviewReplyService.java     # 业务服务接口
│       └── impl/ai/
│           └── ReviewReplyServiceImpl.java # 业务服务实现 (使用 SmartReplyAgent)
│
└── backend-business-reviews-web/
    └── src/main/java/com/businessreviews/web/merchant/
        └── MerchantReplyController.java    # API 控制器
```

## 前端使用

### 回复弹窗界面

在评论管理页面，点击"回复"按钮后弹出的对话框包含：

1. **用户评论展示区** - 显示原始评论内容和评分
2. **AI 智能回复区**
   - 标签提示：「自动识别好评/差评」
   - 赠礼策略下拉选择框（预设选项 + 自定义输入）
   - AI 提示：好评时赠礼是「惊喜回馈」，差评时赠礼是「表达歉意」
   - "✨ AI 智能生成回复"按钮
3. **回复内容编辑区** - 显示 AI 生成的回复，商家可二次编辑
4. **提示信息** - 提醒商家 AI 生成内容仅供参考

### 预设赠礼策略
- 🎁 送 5 元无门槛券
- 🎁 送 8 折折扣券
- 🥤 下次到店送饮料
- 🍽️ 送两份小菜
- 🍰 送精选甜点一份
- 自定义输入

## 期望输出示例

### 场景 1：好评
- **输入**: 评论="味道太赞了，尤其是干锅鸡！"，策略="送饮料券"
- **输出**: "哇！看到同学这么喜欢我们的干锅鸡，老板简直开心得想转圈圈！🥰 您的认可是我们最大的动力！为了感谢您的支持，下次来吃饭送您一张饮料券哦 🥤，期待您带朋友常来！"

### 场景 2：差评
- **输入**: 评论="上菜太慢了，等了半小时。"，策略="送饮料券"
- **输出**: "非常抱歉给您带来不好的体验！😔 让你饿着肚子等了这么久，不仅是身体难受，心情肯定也受影响，真是对不起。我们已经在这个问题上狠狠批评了后厨。为了表达歉意，送您一张饮料券，希望能消消气，给我们一个改进的机会！🙏"

### 场景 3：中性评论
- **输入**: 评论="味道不错但有点贵"，策略=""
- **输出**: "感谢同学的反馈！😊 听到您觉得我们的味道不错，真的很开心！关于价格方面，我们一直在努力平衡食材品质和价格，后续也会推出更多优惠活动。期待您再次光临体验！"

## 注意事项

1. **Token 限制**: 评论内容限制在 1000 字以内
2. **赠礼策略**: 限制在 200 字以内
3. **兜底方案**: AI 调用失败时返回中性语气的默认回复
4. **安全性**: 需要商家登录后才能调用该接口
5. **二次确认**: AI 生成的回复需要商家确认后才会发送

## 依赖配置

确保 `application.yml` 中已配置 LangChain4j：

```yaml
langchain4j:
  open-ai:
    chat-model:
      api-key: ${DEEPSEEK_API_KEY:your-api-key}
      base-url: https://api.deepseek.com
      model-name: deepseek-chat
      temperature: 0.7
      max-tokens: 500
      timeout: 60s
```
