# 头像上传功能 - 阿里云OSS对接文档

## 功能说明

头像上传功能已完成对接,支持两种模式:
1. **本地存储模式**(开发环境): 文件保存在本地目录
2. **阿里云OSS模式**(生产环境): 文件上传到阿里云对象存储

## 配置方式

只需要在 `application.yml` 中配置即可切换模式,无需修改代码。

### 1. 本地存储模式(默认-开发环境)

```yaml
aliyun:
  oss:
    endpoint: oss-cn-hangzhou.aliyuncs.com
    access-key-id: your-access-key-id
    access-key-secret: your-access-key-secret
    bucket-name: business-reviews
    url-prefix: https://business-reviews.oss-cn-hangzhou.aliyuncs.com
    # 本地存储模式：true=使用本地存储，false=使用阿里云OSS
    local-mode: true
    # 本地存储路径
    local-path: ./uploads
```

### 2. 阿里云OSS模式(生产环境)

#### 步骤1: 创建OSS Bucket

1. 登录[阿里云OSS控制台](https://oss.console.aliyun.com/)
2. 创建Bucket,记录以下信息:
   - Bucket名称: 例如 `business-reviews`
   - 地域节点: 例如 `华东1(杭州)` 对应endpoint `oss-cn-hangzhou.aliyuncs.com`
3. 设置Bucket权限为 **公共读**

#### 步骤2: 获取AccessKey

1. 登录[阿里云AccessKey管理](https://ram.console.aliyun.com/manage/ak)
2. 创建AccessKey,记录:
   - Access Key ID
   - Access Key Secret

#### 步骤3: 修改配置文件

```yaml
aliyun:
  oss:
    # OSS服务endpoint (根据你的Bucket地域修改)
    endpoint: oss-cn-hangzhou.aliyuncs.com
    
    # 阿里云AccessKeyId
    access-key-id: LTAI5t********  # 填写你的AccessKey ID
    
    # 阿里云AccessKeySecret
    access-key-secret: ****************  # 填写你的AccessKey Secret
    
    # Bucket名称
    bucket-name: business-reviews  # 填写你的Bucket名称
    
    # 访问URL前缀
    url-prefix: https://business-reviews.oss-cn-hangzhou.aliyuncs.com  # 根据你的Bucket修改
    
    # 切换到OSS模式
    local-mode: false
    
    # 本地路径(OSS模式下不使用)
    local-path: ./uploads
```

## 使用方式

### 前端使用

在设置页面点击头像即可:
1. 选择图片(相册或拍照)
2. 自动上传并更新
3. 显示上传成功提示

### 文件存储结构

**本地模式:**
```
./uploads/
  └── avatars/
      └── 2024/
          └── 12/
              └── 04/
                  └── uuid.jpg
```

**OSS模式:**
```
Bucket根目录/
  └── avatars/
      └── 2024/
          └── 12/
              └── 04/
                  └── uuid.jpg
```

## API接口

### 上传头像
- **地址**: `POST /api/upload/avatar`
- **参数**: `file` (MultipartFile)
- **返回**:
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "https://xxx.oss-cn-hangzhou.aliyuncs.com/avatars/2024/12/04/xxx.jpg"
  }
}
```

### 上传普通图片
- **地址**: `POST /api/upload/image`
- **参数**: `file` (MultipartFile)
- **返回**: 同上

### 批量上传图片
- **地址**: `POST /api/upload/images`
- **参数**: `files` (MultipartFile[])
- **返回**:
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "urls": [
      "https://xxx.oss-cn-hangzhou.aliyuncs.com/images/2024/12/04/xxx1.jpg",
      "https://xxx.oss-cn-hangzhou.aliyuncs.com/images/2024/12/04/xxx2.jpg"
    ]
  }
}
```

## 文件限制

- **最大文件大小**: 10MB
- **支持格式**: JPG, JPEG, PNG, GIF, WEBP, BMP
- **批量上传**: 最多9张

## 常见问题

### 1. 本地模式图片无法访问?

确保:
- `local-path` 配置的路径存在且有写入权限
- 图片URL格式为: `http://localhost:8080/static/avatars/...`

### 2. OSS模式上传失败?

检查:
- AccessKey ID和Secret是否正确
- Bucket名称和endpoint是否匹配
- Bucket权限是否设置为公共读
- 网络连接是否正常

### 3. 如何切换环境?

只需修改 `local-mode` 参数:
- 开发环境: `local-mode: true` (使用本地存储)
- 生产环境: `local-mode: false` (使用OSS)

## 安全建议

生产环境建议:
1. 使用环境变量存储AccessKey,不要直接写在配置文件中:
   ```yaml
   access-key-id: ${ALIYUN_ACCESS_KEY_ID}
   access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET}
   ```

2. 配置Bucket的防盗链规则

3. 开启OSS的HTTPS访问

4. 定期更新AccessKey

## 测试步骤

1. **启动后端服务**
2. **打开前端项目**
3. **登录用户账号**
4. **进入设置页面**
5. **点击头像**,选择图片
6. **等待上传**,查看是否显示"头像修改成功"
7. **检查头像是否更新**

### 验证本地模式
- 检查 `./uploads/avatars/` 目录下是否有文件
- 图片URL应该是: `/static/avatars/...`

### 验证OSS模式
- 登录OSS控制台,检查Bucket中是否有文件
- 图片URL应该是: `https://your-bucket.oss-cn-hangzhou.aliyuncs.com/avatars/...`
