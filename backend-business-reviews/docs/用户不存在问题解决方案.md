# 用户不存在问题解决方案

## 问题分析

### 错误现象
```
前端日志:
- Token中userId: 22
- 缓存中userId: "22"
- 手机号: 16750152199

后端日志:
- 查询: WHERE id=? Parameters: 20(Long)
- 结果: Total: 0
- 错误: 用户不存在
```

### 问题原因

**可能原因1: 用户ID不一致**
- Token中存储的是userId=22
- 但数据库中用户22不存在或被删除
- 可能是测试时删除重建用户导致

**可能原因2: 数据库被清空/重置**
- 开发环境中数据库被重置
- 用户表被清空重建
- 旧的Token和缓存还指向旧的userId

**可能原因3: 前端缓存问题**
- localStorage缓存了旧的userInfo
- Token也是旧的
- 需要清除缓存重新登录

## 立即解决方案

### 方案1: 前端清除缓存并重新登录 ⭐推荐

**步骤**:
1. 打开前端开发者工具(F12)
2. 切换到"Application"标签
3. 点击"Storage" -> "Local Storage"
4. 点击你的网站域名
5. 找到并删除以下键:
   - `token`
   - `userInfo`
   - 其他相关缓存
6. 刷新页面
7. 重新登录

**或者使用控制台**:
```javascript
// 在浏览器控制台执行
uni.removeStorageSync('token')
uni.removeStorageSync('userInfo')
uni.reLaunch({ url: '/pages/login/login' })
```

### 方案2: 数据库中插入用户22

如果确定需要userId=22的用户,可以手动插入:

```sql
-- 先检查用户22是否存在
SELECT * FROM users WHERE id = 22;

-- 如果不存在,检查手机号是否存在
SELECT * FROM users WHERE phone = '16750152199';

-- 如果手机号存在但ID不是22,更新ID(不推荐,可能破坏外键)
-- 如果都不存在,插入新用户
INSERT INTO users (id, phone, username, avatar, status, created_at, updated_at)
VALUES (
    22,
    '16750152199',
    '用户2199',
    'https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head10.png',
    1,
    NOW(),
    NOW()
);

-- 同时需要创建用户统计记录
INSERT INTO user_stats (user_id, following_count, follower_count, like_count, favorite_count, note_count, created_at, updated_at)
VALUES (22, 0, 0, 0, 0, 0, NOW(), NOW());
```

### 方案3: 修改Token使其指向正确的用户

**不推荐** - Token应该通过登录接口生成,不应手动修改

## 长期解决方案

### 1. 添加更友好的错误提示

修改后端UserServiceImpl.java:

```java
@Override
public UserInfoResponse getUserInfo(Long userId) {
    User user = userMapper.selectById(userId);
    if (user == null) {
        log.warn("用户不存在: userId={}", userId);
        // 清除可能的脏数据
        redisUtil.delete(Constants.RedisKey.USER_INFO + userId);
        throw new BusinessException(40401, "用户信息已失效,请重新登录");
    }
    // ... 其他代码
}
```

### 2. 前端添加Token失效自动跳转

修改前端request拦截器:

```javascript
// 在响应拦截器中处理401和40401
if (response.data.code === 401 || response.data.code === 40401) {
    // 清除本地缓存
    uni.removeStorageSync('token')
    uni.removeStorageSync('userInfo')
    
    // 提示用户
    uni.showToast({
        title: '登录已失效,请重新登录',
        icon: 'none',
        duration: 2000
    })
    
    // 跳转到登录页
    setTimeout(() => {
        uni.reLaunch({
            url: '/pages/login/login'
        })
    }, 2000)
}
```

### 3. 添加Token黑名单检查

当用户信息不存在时,自动将Token加入黑名单:

```java
@Override
public UserInfoResponse getUserInfo(Long userId) {
    User user = userMapper.selectById(userId);
    if (user == null) {
        // Token指向的用户不存在,加入黑名单
        String token = getCurrentToken(); // 需要实现获取当前请求的token
        if (token != null) {
            long expireTime = jwtUtil.getExpireTime(token);
            if (expireTime > 0) {
                String blacklistKey = Constants.RedisKey.TOKEN_BLACKLIST + token;
                redisUtil.set(blacklistKey, "1", expireTime);
            }
        }
        throw new BusinessException(40401, "用户信息已失效,请重新登录");
    }
    // ...
}
```

### 4. 数据库约束

确保数据一致性:

```sql
-- 添加外键约束(如果还没有)
ALTER TABLE user_stats 
ADD CONSTRAINT fk_user_stats_user 
FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;

-- 这样删除用户时,相关的统计数据也会自动删除
```

## 测试验证

### 1. 验证用户是否存在
```sql
-- 查询用户22
SELECT id, phone, username, avatar, status 
FROM users 
WHERE id = 22;

-- 查询手机号16750152199
SELECT id, phone, username, avatar, status 
FROM users 
WHERE phone = '16750152199';

-- 查看所有用户
SELECT id, phone, username, avatar, status, created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 10;
```

### 2. 验证用户统计
```sql
SELECT * FROM user_stats WHERE user_id = 22;
```

### 3. 测试登录流程
1. 清除前端缓存
2. 重新登录
3. 查看返回的userId
4. 确认可以正常访问个人中心

## 预防措施

### 1. 开发环境数据保护
- 不要随意删除用户数据
- 使用测试专用账号
- 定期备份开发数据库

### 2. 代码层面
- 统一错误处理
- Token失效自动跳转
- 添加详细日志

### 3. 数据库层面
- 使用外键约束保证数据一致性
- 定期检查孤儿数据
- 软删除代替硬删除(添加deleted_at字段)

## 当前建议操作

**立即执行(选择其一)**:

**选项A: 重新登录(推荐)** ⭐
1. 前端浏览器按F12
2. 控制台执行:
   ```javascript
   uni.removeStorageSync('token')
   uni.removeStorageSync('userInfo')
   location.reload()
   ```
3. 重新使用手机号+验证码登录

**选项B: 修复数据库**
1. 执行 `check_user_issue.sql` 检查数据
2. 根据结果决定是否插入用户22
3. 或者使用正确的用户ID重新登录

**推荐选择选项A**,因为:
- 最简单快速
- 不会破坏数据一致性
- 模拟真实用户场景
- Token会包含正确的userId

## 总结

这个问题的核心是:**Token中的userId在数据库中不存在**

最快的解决方法:**清除缓存,重新登录**

长期的优化:**添加友好的错误提示和自动跳转逻辑**
