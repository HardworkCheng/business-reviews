# åç«¯æ¥å£æ–‡æ¡£

## é¡¹ç›®ï¼šç¾é£Ÿç‚¹è¯„ç³»ç»Ÿåç«¯API

**ç‰ˆæœ¬ï¼š** v2.0.0  
**æ›´æ–°æ—¶é—´ï¼š** 2024-12-03  
**è¯´æ˜ï¼š** æœ¬æ–‡æ¡£åŸºäºå‰ç«¯APIæ¥å£è®¾è®¡ï¼Œç¡®ä¿å‰åç«¯å®Œç¾å¯¹æ¥è”è°ƒ

---

## å‰åç«¯å¯¹æ¥è¯´æ˜

### å‰ç«¯åŸºç¡€é…ç½®
- **å¼€å‘ç¯å¢ƒBASE_URL**: `http://localhost:8080/api`
- **ç”Ÿäº§ç¯å¢ƒBASE_URL**: `https://api.business-reviews.com/api`
- **è®¤è¯æ–¹å¼**: Bearer Tokenï¼ˆè¯·æ±‚å¤´ `Authorization: Bearer {token}`ï¼‰
- **è¯·æ±‚Content-Type**: `application/json`
- **æ–‡ä»¶ä¸Šä¼ Content-Type**: `multipart/form-data`

### ç»Ÿä¸€å“åº”æ ¼å¼

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {}  // å‰ç«¯ç›´æ¥ä½¿ç”¨dataéƒ¨åˆ†
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "code": 40001,
  "message": "é”™è¯¯ä¿¡æ¯",
  "data": null
}
```

### å‰ç«¯å¤„ç†é€»è¾‘
- âœ… **code=200**: æˆåŠŸï¼Œè¿”å›`data`
- âŒ **code=401**: Tokenè¿‡æœŸï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µ
- âš ï¸ **å…¶ä»–code**: è‡ªåŠ¨æ˜¾ç¤º`message`æç¤º

---

## æŠ€æœ¯æ ˆå»ºè®®

### åç«¯æ¡†æ¶
- **Spring Boot 2.7+** - Javaåç«¯æ¡†æ¶
- **MyBatis-Plus 3.5+** - ORMæ¡†æ¶
- **MySQL 8.0+** - å…³ç³»å‹æ•°æ®åº“
- **Redis 6.0+** - ç¼“å­˜æ•°æ®åº“
- **Spring Security + JWT** - è®¤è¯æˆæƒ

### å¯é€‰æŠ€æœ¯
- **Elasticsearch** - å…¨æ–‡æœç´¢å¼•æ“
- **RabbitMQ** - æ¶ˆæ¯é˜Ÿåˆ—
- **OSS** - å¯¹è±¡å­˜å‚¨ï¼ˆé˜¿é‡Œäº‘/ä¸ƒç‰›äº‘ï¼‰
- **WebSocket** - å®æ—¶èŠå¤©

---

## é¡¹ç›®ç»“æ„å»ºè®®

```
backend-business-reviews/
â”œâ”€â”€ src/main/java/com/businessreviews/
â”‚   â”œâ”€â”€ config/              # é…ç½®ç±»
â”‚   â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â”‚   â”œâ”€â”€ CorsConfig.java
â”‚   â”‚   â””â”€â”€ WebMvcConfig.java
â”‚   â”œâ”€â”€ controller/          # æ§åˆ¶å™¨ï¼ˆå¯¹åº”å‰ç«¯APIæ¨¡å—ï¼‰
â”‚   â”‚   â”œâ”€â”€ AuthController.java        # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ UserController.java        # ç”¨æˆ·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ NoteController.java        # ç¬”è®°æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ CommentController.java     # è¯„è®ºæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ShopController.java        # å•†å®¶æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ MessageController.java     # æ¶ˆæ¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ UploadController.java      # ä¸Šä¼ æ¨¡å—
â”‚   â”‚   â””â”€â”€ CommonController.java      # å…¬å…±æ¨¡å—ï¼ˆåˆ†ç±»ã€è¯é¢˜ã€æœç´¢ï¼‰
â”‚   â”œâ”€â”€ service/             # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ AuthService.java
â”‚   â”‚   â”œâ”€â”€ UserService.java
â”‚   â”‚   â”œâ”€â”€ NoteService.java
â”‚   â”‚   â”œâ”€â”€ ShopService.java
â”‚   â”‚   â””â”€â”€ MessageService.java
â”‚   â”œâ”€â”€ mapper/              # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ entity/              # å®ä½“ç±»
â”‚   â”œâ”€â”€ dto/                 # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”œâ”€â”€ common/              # å…¬å…±ç±»
â”‚   â”‚   â”œâ”€â”€ Result.java      # ç»Ÿä¸€å“åº”
â”‚   â”‚   â”œâ”€â”€ PageResult.java  # åˆ†é¡µå“åº”
â”‚   â”‚   â””â”€â”€ Constants.java   # å¸¸é‡
â”‚   â”œâ”€â”€ exception/           # å¼‚å¸¸å¤„ç†
â”‚   â”‚   â”œâ”€â”€ GlobalExceptionHandler.java
â”‚   â”‚   â””â”€â”€ BusinessException.java
â”‚   â”œâ”€â”€ interceptor/         # æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ AuthInterceptor.java
â”‚   â””â”€â”€ util/                # å·¥å…·ç±»
â”‚       â”œâ”€â”€ JwtUtil.java
â”‚       â”œâ”€â”€ RedisUtil.java
â”‚       â””â”€â”€ SmsUtil.java
```

---

## ä¸€ã€è®¤è¯æ¨¡å— (AuthController)

### 1.1 å‘é€éªŒè¯ç 

**å‰ç«¯è°ƒç”¨ï¼š** `api.auth.sendCode(phone, type)`

**æ¥å£åœ°å€ï¼š** `POST /api/auth/send-code`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "phone": "13800138000",
  "type": 1
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `phone` (String, å¿…å¡«): æ‰‹æœºå·
- `type` (Integer, å¿…å¡«): ç±»å‹ 1=ç™»å½•ï¼Œ2=æ³¨å†Œï¼Œ3=é‡ç½®å¯†ç 

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯æ‰‹æœºå·æ ¼å¼ï¼ˆ11ä½æ•°å­—ï¼‰
2. æ£€æŸ¥åŒä¸€æ‰‹æœºå·60ç§’å†…æ˜¯å¦å·²å‘é€ï¼ˆé˜²åˆ·ï¼‰
3. ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
4. è®¾ç½®5åˆ†é’Ÿè¿‡æœŸæ—¶é—´
5. è°ƒç”¨çŸ­ä¿¡æœåŠ¡å‘é€éªŒè¯ç 
6. å°†éªŒè¯ç å­˜å…¥Redisï¼ˆkey: `sms:code:{phone}`, expire: 300sï¼‰
7. è®°å½•å‘é€é¢‘ç‡é™åˆ¶ï¼ˆkey: `sms:limit:{phone}`, expire: 60sï¼‰
8. åŒæ—¶è®°å½•åˆ°æ•°æ®åº“`verification_codes`è¡¨

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "éªŒè¯ç å·²å‘é€",
  "data": null
}
```

**é”™è¯¯ç ï¼š**
- 40001: æ‰‹æœºå·æ ¼å¼é”™è¯¯
- 40005: æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•

**å®ç°è¦ç‚¹ï¼š**
```java
@PostMapping("/send-code")
public Result<?> sendCode(@RequestBody @Valid SendCodeRequest request) {
    // 1. éªŒè¯æ‰‹æœºå·æ ¼å¼
    if (!PhoneUtil.isValid(request.getPhone())) {
        return Result.error(40001, "æ‰‹æœºå·æ ¼å¼é”™è¯¯");
    }
    
    // 2. æ£€æŸ¥å‘é€é¢‘ç‡ï¼ˆRedisï¼‰
    String limitKey = "sms:limit:" + request.getPhone();
    if (redisUtil.hasKey(limitKey)) {
        return Result.error(40005, "æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // 3. ç”ŸæˆéªŒè¯ç 
    String code = RandomUtil.randomNumbers(6);
    
    // 4. å‘é€çŸ­ä¿¡
    smsService.sendCode(request.getPhone(), code);
    
    // 5. å­˜å‚¨åˆ°Redis
    redisUtil.set("sms:code:" + request.getPhone(), code, 300);
    redisUtil.set(limitKey, "1", 60);
    
    // 6. è®°å½•åˆ°æ•°æ®åº“
    verificationCodeService.saveCode(request.getPhone(), code, request.getType());
    
    return Result.success("éªŒè¯ç å·²å‘é€");
}
```

---

### 1.2 éªŒè¯ç ç™»å½•

**å‰ç«¯è°ƒç”¨ï¼š** `api.auth.loginByCode(phone, code)`

**æ¥å£åœ°å€ï¼š** `POST /api/auth/login-by-code`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "phone": "13800138000",
  "code": "123456"
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `phone` (String, å¿…å¡«): æ‰‹æœºå·
- `code` (String, å¿…å¡«): 6ä½éªŒè¯ç 

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯æ‰‹æœºå·å’ŒéªŒè¯ç æ ¼å¼
2. ä»Redisä¸­è·å–éªŒè¯ç è¿›è¡ŒéªŒè¯
3. éªŒè¯é€šè¿‡åï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
4. ä¸å­˜åœ¨åˆ™è‡ªåŠ¨æ³¨å†Œï¼ˆåˆ›å»ºç”¨æˆ·è®°å½•ã€ç”¨æˆ·ç»Ÿè®¡è®°å½•ï¼‰
5. ç”ŸæˆJWT Tokenï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰
6. æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
7. åˆ é™¤å·²ä½¿ç”¨çš„éªŒè¯ç 
8. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "userId": "1001",
      "username": "ç¾é£Ÿæ¢åº—å°ç‹",
      "avatar": "https://example.com/avatar.jpg",
      "phone": "138****8000"
    }
  }
}
```

> å®‰å…¨è¯´æ˜ï¼šç™»å½•å“åº”ä»…è¿”å›è„±æ•æ‰‹æœºå·ã€‚éœ€è¦å®Œæ•´æ‰‹æœºå·çš„æ•æ„Ÿæ“ä½œè¯·è°ƒç”¨`GET /user/phone`å¹¶ç»“åˆæƒé™éªŒè¯ã€‚

**é”™è¯¯ç ï¼š**
- 40002: éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ
- 40001: æ‰‹æœºå·æ ¼å¼é”™è¯¯

**å®ç°è¦ç‚¹ï¼š**
```java
@PostMapping("/login-by-code")
public Result<LoginResponse> loginByCode(@RequestBody @Valid LoginByCodeRequest request) {
    // 1. éªŒè¯ç æ ¡éªŒ
    String cacheCode = redisUtil.get("sms:code:" + request.getPhone());
    if (!request.getCode().equals(cacheCode)) {
        return Result.error(40002, "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ");
    }
    
    // 2. æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ·
    User user = userService.getByPhone(request.getPhone());
    if (user == null) {
        user = userService.register(request.getPhone());
    }
    
    // 3. ç”ŸæˆToken
    String token = jwtUtil.generateToken(user.getId());
    
    // 4. åˆ é™¤éªŒè¯ç 
    redisUtil.delete("sms:code:" + request.getPhone());
    
    // 5. è¿”å›ç»“æœ
    LoginResponse response = new LoginResponse();
    response.setToken(token);
    response.setUserInfo(UserConverter.toDTO(user));
    
    return Result.success(response);
}
```

---

### 1.3 ç¬¬ä¸‰æ–¹ç™»å½•

**å‰ç«¯è°ƒç”¨ï¼š** `api.auth.oauthLogin(type, code)`

**æ¥å£åœ°å€ï¼š** `POST /api/auth/oauth-login`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "type": "wechat",
  "code": "oauth_code"
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `type` (String, å¿…å¡«): ç™»å½•ç±»å‹ wechat/qq/weibo
- `code` (String, å¿…å¡«): OAuthæˆæƒç 

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®typeè°ƒç”¨ä¸åŒçš„ç¬¬ä¸‰æ–¹OAuthæ¥å£
2. ä½¿ç”¨codeæ¢å–access_token
3. è·å–ç¬¬ä¸‰æ–¹ç”¨æˆ·ä¿¡æ¯ï¼ˆopenidã€æ˜µç§°ã€å¤´åƒï¼‰
4. æ ¹æ®openidæŸ¥æ‰¾ç”¨æˆ·
5. ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·
6. ç”ŸæˆJWT Token
7. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "userId": "1001",
      "username": "ç¾é£Ÿæ¢åº—å°ç‹",
      "avatar": "https://example.com/avatar.jpg",
      "phone": "138****8000"
    }
  }
}
```

---

### 1.4 é€€å‡ºç™»å½•

**å‰ç«¯è°ƒç”¨ï¼š** `api.auth.logout()`

**æ¥å£åœ°å€ï¼š** `POST /api/auth/logout`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— è¯·æ±‚ä½“
- éœ€è¦Authorizationå¤´

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. ä»è¯·æ±‚å¤´è·å–Token
2. å°†TokenåŠ å…¥é»‘åå•ï¼ˆRedisï¼‰
3. è®¾ç½®è¿‡æœŸæ—¶é—´ä¸ºTokenå‰©ä½™æœ‰æ•ˆæœŸ

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "é€€å‡ºæˆåŠŸ",
  "data": null
}
```

**å®ç°è¦ç‚¹ï¼š**
```java
@PostMapping("/logout")
public Result<?> logout(@RequestHeader("Authorization") String authorization) {
    String token = authorization.replace("Bearer ", "");
    
    // è·å–Tokenå‰©ä½™æœ‰æ•ˆæœŸ
    long expireTime = jwtUtil.getExpireTime(token);
    
    // åŠ å…¥é»‘åå•
    redisUtil.set("token:blacklist:" + token, "1", expireTime);
    
    return Result.success("é€€å‡ºæˆåŠŸ");
}
```

---

## äºŒã€ç”¨æˆ·æ¨¡å— (UserController)

### 2.1 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.getUserInfo()`

**æ¥å£åœ°å€ï¼š** `GET /api/user/info`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— å‚æ•°
- éœ€è¦Authorizationå¤´

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. ä»Tokenä¸­è§£æç”¨æˆ·ID
2. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆusersè¡¨ï¼‰
3. æŸ¥è¯¢ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼ˆuser_statsè¡¨ï¼‰
4. åˆå¹¶è¿”å›

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": "1001",
    "username": "ç¾é£Ÿæ¢åº—å°ç‹",
    "avatar": "https://example.com/avatar.jpg",
    "bio": "çƒ­çˆ±ç¾é£Ÿï¼Œå–œæ¬¢æ¢åº— ğŸœ",
    "phone": "138****8000",
    "gender": 1,
    "birthday": "1995-01-01",
    "followingCount": 128,
    "followerCount": 3456,
    "likeCount": 12345,
    "favoriteCount": 567,
    "noteCount": 89
  }
}
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œkey: `user:info:{userId}`
- è¿‡æœŸæ—¶é—´: 30åˆ†é’Ÿ
- ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜

---

### 2.2 æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.updateUserInfo(data)`

**æ¥å£åœ°å€ï¼š** `PUT /api/user/info`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "username": "ç¾é£Ÿæ¢åº—å°ç‹",
  "avatar": "https://example.com/avatar.jpg",
  "bio": "çƒ­çˆ±ç¾é£Ÿï¼Œå–œæ¬¢æ¢åº—",
  "gender": 1,
  "birthday": "1995-01-01"
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `username` (String, å¯é€‰): ç”¨æˆ·åï¼Œ2-20å­—ç¬¦
- `avatar` (String, å¯é€‰): å¤´åƒURL
- `bio` (String, å¯é€‰): ä¸ªäººç®€ä»‹ï¼Œæœ€å¤š100å­—ç¬¦
- `gender` (Integer, å¯é€‰): æ€§åˆ« 0=ä¿å¯†ï¼Œ1=ç”·ï¼Œ2=å¥³
- `birthday` (String, å¯é€‰): ç”Ÿæ—¥ æ ¼å¼:YYYY-MM-DD

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯å‚æ•°ï¼ˆç”¨æˆ·åé•¿åº¦ã€å¤´åƒURLæ ¼å¼ç­‰ï¼‰
2. æ›´æ–°ç”¨æˆ·ä¿¡æ¯
3. æ¸…é™¤ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "æ›´æ–°æˆåŠŸ",
  "data": null
}
```

---

### 2.3 è·å–æˆ‘çš„ç¬”è®°åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.getMyNotes(pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/user/notes`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. åˆ†é¡µæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç¬”è®°
2. æŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
3. åªè¿”å›å¿…è¦å­—æ®µ

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "1001",
        "image": "https://example.com/note1.jpg",
        "title": "æ­å·è¶…å¥½åƒçš„çƒ¤è‚‰åº—ï¼äººå‡100+",
        "likes": 1234,
        "views": 5678,
        "createdAt": "2024-12-01 10:30:00"
      }
    ],
    "total": 89,
    "pageNum": 1,
    "pageSize": 10,
    "hasMore": true
  }
}
```

**SQLç¤ºä¾‹ï¼š**
```sql
SELECT id, cover_image as image, title, like_count as likes, view_count as views, created_at
FROM notes
WHERE user_id = ? AND status = 1
ORDER BY created_at DESC
LIMIT ?, ?
```

---

### 2.4 è·å–æˆ‘çš„æ”¶è—åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.getMyFavorites(type, pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/user/favorites`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `type` (Integer): ç±»å‹ 1=ç¬”è®°ï¼Œ2=å•†å®¶
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®typeæŸ¥è¯¢ä¸åŒçš„æ”¶è—è¡¨
2. å…³è”æŸ¥è¯¢ç¬”è®°æˆ–å•†å®¶ä¿¡æ¯
3. æŒ‰æ”¶è—æ—¶é—´å€’åºæ’åˆ—

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "1001",
        "type": 1,
        "targetId": "2001",
        "image": "https://example.com/note.jpg",
        "title": "ç¬”è®°æ ‡é¢˜",
        "createdAt": "2024-12-01 10:30:00"
      }
    ],
    "total": 567,
    "pageNum": 1,
    "pageSize": 10,
    "hasMore": true
  }
}
```

---

### 2.5 è·å–æµè§ˆå†å²

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.getBrowseHistory(pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/user/history`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŸ¥è¯¢ç”¨æˆ·æµè§ˆå†å²ï¼ˆbrowse_historyè¡¨ï¼‰
2. å…³è”æŸ¥è¯¢ç¬”è®°æˆ–å•†å®¶ä¿¡æ¯
3. æŒ‰æµè§ˆæ—¶é—´å€’åºæ’åˆ—

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "1001",
        "type": 1,
        "targetId": "2001",
        "image": "https://example.com/note.jpg",
        "title": "ç¬”è®°æ ‡é¢˜",
        "createdAt": "2024-12-03 09:30:00"
      }
    ],
    "total": 100,
    "hasMore": true
  }
}
```

---

### 2.6 å…³æ³¨ç”¨æˆ·

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.followUser(userId)`

**æ¥å£åœ°å€ï¼š** `POST /api/user/follow`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "userId": "1002"
}
```

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨ï¼ˆé¿å…é‡å¤ï¼‰
2. æ£€æŸ¥æ˜¯å¦å…³æ³¨è‡ªå·±
3. æ’å…¥å…³æ³¨è®°å½•ï¼ˆuser_followsè¡¨ï¼‰
4. æ›´æ–°å½“å‰ç”¨æˆ·çš„å…³æ³¨æ•°+1
5. æ›´æ–°ç›®æ ‡ç”¨æˆ·çš„ç²‰ä¸æ•°+1
6. å‘é€ç³»ç»Ÿé€šçŸ¥ç»™è¢«å…³æ³¨è€…

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å…³æ³¨æˆåŠŸ",
  "data": null
}
```

---

### 2.7 å–æ¶ˆå…³æ³¨ç”¨æˆ·

**å‰ç«¯è°ƒç”¨ï¼š** `api.user.unfollowUser(userId)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/user/follow/{userId}`

**å‰ç«¯è¯·æ±‚ï¼š**
- URLå‚æ•°ï¼šuserId

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²å…³æ³¨
2. åˆ é™¤å…³æ³¨è®°å½•
3. æ›´æ–°å½“å‰ç”¨æˆ·çš„å…³æ³¨æ•°-1
4. æ›´æ–°ç›®æ ‡ç”¨æˆ·çš„ç²‰ä¸æ•°-1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å–æ¶ˆå…³æ³¨æˆåŠŸ",
  "data": null
}
```

---

## ä¸‰ã€ç¬”è®°æ¨¡å— (NoteController)

### 3.1 è·å–æ¨èç¬”è®°åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.getRecommendedNotes(pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/notes/recommended`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. åˆ†é¡µæŸ¥è¯¢æ¨èç¬”è®°ï¼ˆis_recommend=1æˆ–æŒ‰çƒ­åº¦æ’åºï¼‰
2. å…³è”æŸ¥è¯¢ä½œè€…ä¿¡æ¯
3. æŒ‰ç‚¹èµæ•°ã€åˆ›å»ºæ—¶é—´ç»¼åˆæ’åº
4. è®¡ç®—çƒ­åº¦æ ‡ç­¾ï¼ˆçƒ­é—¨ã€æ–°å“ã€æ¨èï¼‰

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "1001",
        "image": "https://example.com/note1.jpg",
        "title": "æ­å·è¶…å¥½åƒçš„çƒ¤è‚‰åº—ï¼äººå‡100+",
        "author": "ç¾é£Ÿæ¢åº—å°ç‹",
        "authorAvatar": "https://example.com/avatar.jpg",
        "authorId": "2001",
        "likes": 1234,
        "views": 5678,
        "tag": "çƒ­é—¨",
        "tagClass": "tag-hot",
        "createdAt": "2024-12-01 10:30:00"
      }
    ],
    "pageNum": 1,
    "pageSize": 10,
    "hasMore": true
  }
}
```

**SQLç¤ºä¾‹ï¼š**
```sql
SELECT n.*, u.username as author, u.avatar as authorAvatar
FROM notes n
LEFT JOIN users u ON n.user_id = u.id
WHERE n.status = 1
ORDER BY (n.like_count * 0.7 + n.comment_count * 0.3) DESC, n.created_at DESC
LIMIT ?, ?
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- é¦–é¡µæ•°æ®ç¼“å­˜5åˆ†é’Ÿ
- key: `notes:recommended:page:{pageNum}`

---

### 3.2 è·å–ç¬”è®°è¯¦æƒ…

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.getNoteDetail(id)`

**æ¥å£åœ°å€ï¼š** `GET /api/notes/{id}`

**å‰ç«¯è¯·æ±‚ï¼š**
- URLå‚æ•°ï¼šid
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŸ¥è¯¢ç¬”è®°è¯¦æƒ…
2. å…³è”æŸ¥è¯¢ä½œè€…ä¿¡æ¯
3. æŸ¥è¯¢ç¬”è®°æ ‡ç­¾
4. æŸ¥è¯¢å…³è”å•†å®¶ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
5. å¦‚æœå·²ç™»å½•ï¼ŒæŸ¥è¯¢æ˜¯å¦å·²ç‚¹èµã€æ”¶è—
6. å¼‚æ­¥å¢åŠ æµè§ˆé‡
7. è®°å½•æµè§ˆå†å²ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "1001",
    "image": "https://example.com/note1.jpg",
    "images": [
      "https://example.com/note1-1.jpg",
      "https://example.com/note1-2.jpg"
    ],
    "title": "æ­å·è¶…å¥½åƒçš„çƒ¤è‚‰åº—ï¼",
    "content": "è¿™å®¶åº—çœŸçš„å¤ªå¥½åƒäº†ï¼Œå¼ºçƒˆæ¨è...",
    "author": "ç¾é£Ÿæ¢åº—å°ç‹",
    "authorAvatar": "https://example.com/avatar.jpg",
    "authorId": "2001",
    "publishTime": "2å°æ—¶å‰",
    "tags": ["ç¾é£Ÿ", "æ¢åº—", "æ­å·"],
    "likeCount": 1234,
    "commentCount": 128,
    "viewCount": 3456,
    "favoriteCount": 567,
    "isLiked": false,
    "isBookmarked": false,
    "location": "æ­å·Â·ä¸Šå¡˜è·¯",
    "shopId": "3001",
    "shopName": "è”¡é¦¬æ´ªæ¶›çƒ¤è‚‰",
    "createdAt": "2024-12-01 10:30:00"
  }
}
```

**å®ç°è¦ç‚¹ï¼š**
```java
@GetMapping("/{id}")
public Result<NoteDetailDTO> getNoteDetail(@PathVariable Long id) {
    Note note = noteService.getById(id);
    if (note == null || note.getStatus() != 1) {
        return Result.error(40402, "ç¬”è®°ä¸å­˜åœ¨");
    }
    
    // æŸ¥è¯¢ä½œè€…ã€æ ‡ç­¾ç­‰ä¿¡æ¯
    User author = userService.getById(note.getUserId());
    List<String> tags = noteTagService.getTagsByNoteId(id);
    
    // æŸ¥è¯¢ç”¨æˆ·äº’åŠ¨çŠ¶æ€ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
    Long userId = UserContext.getUserId();
    boolean isLiked = false;
    boolean isBookmarked = false;
    if (userId != null) {
        isLiked = noteLikeService.isLiked(userId, id);
        isBookmarked = noteBookmarkService.isBookmarked(userId, id);
    }
    
    NoteDetailDTO dto = NoteConverter.toDetailDTO(note, author, tags);
    dto.setIsLiked(isLiked);
    dto.setIsBookmarked(isBookmarked);
    
    // å¼‚æ­¥å¢åŠ æµè§ˆé‡
    CompletableFuture.runAsync(() -> {
        noteService.increaseViewCount(id);
        if (userId != null) {
            browseHistoryService.record(userId, 1, id);
        }
    });
    
    return Result.success(dto);
}
```

---

### 3.3 å‘å¸ƒç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.publishNote(data)`

**æ¥å£åœ°å€ï¼š** `POST /api/notes`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "title": "ç¬”è®°æ ‡é¢˜",
  "content": "ç¬”è®°å†…å®¹",
  "images": [
    "https://example.com/image1.jpg",
    "https://example.com/image2.jpg"
  ],
  "shopId": "3001",
  "location": "æ­å·Â·ä¸Šå¡˜è·¯",
  "latitude": 30.2741,
  "longitude": 120.1551,
  "tags": ["ç¾é£Ÿ", "æ¢åº—"],
  "topics": ["1", "2"]
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `title` (String, å¿…å¡«): ç¬”è®°æ ‡é¢˜ï¼Œ2-100å­—ç¬¦
- `content` (String, å¿…å¡«): ç¬”è®°å†…å®¹ï¼Œ10-5000å­—ç¬¦
- `images` (Array, å¿…å¡«): å›¾ç‰‡URLæ•°ç»„ï¼Œè‡³å°‘1å¼ ï¼Œæœ€å¤š9å¼ 
- `shopId` (String, å¯é€‰): å…³è”å•†å®¶ID
- `location` (String, å¯é€‰): ä½ç½®ä¿¡æ¯
- `latitude` (Double, å¯é€‰): çº¬åº¦
- `longitude` (Double, å¯é€‰): ç»åº¦
- `tags` (Array, å¯é€‰): æ ‡ç­¾æ•°ç»„
- `topics` (Array, å¯é€‰): è¯é¢˜IDæ•°ç»„

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. å‚æ•°æ ¡éªŒ
2. å†…å®¹å®‰å…¨å®¡æ ¸ï¼ˆæ•æ„Ÿè¯è¿‡æ»¤ï¼‰
3. æ’å…¥ç¬”è®°è®°å½•ï¼ˆå–images[0]ä½œä¸ºå°é¢ï¼‰
4. æ’å…¥æ ‡ç­¾å…³è”ï¼ˆnote_tagsè¡¨ï¼‰
5. æ’å…¥è¯é¢˜å…³è”ï¼ˆnote_topicsè¡¨ï¼‰
6. æ›´æ–°ç”¨æˆ·ç¬”è®°æ•°+1
7. å¦‚æœå…³è”å•†å®¶ï¼Œæ›´æ–°å•†å®¶ç¬”è®°æ•°

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å‘å¸ƒæˆåŠŸ",
  "data": {
    "noteId": "1001"
  }
}
```

---

### 3.4 ç‚¹èµç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.likeNote(id)`

**æ¥å£åœ°å€ï¼š** `POST /api/notes/{id}/like`

**å‰ç«¯è¯·æ±‚ï¼š**
- URLå‚æ•°ï¼šid
- æ— è¯·æ±‚ä½“

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
2. æ’å…¥ç‚¹èµè®°å½•ï¼ˆuser_note_likesè¡¨ï¼‰
3. ç¬”è®°ç‚¹èµæ•°+1
4. ä½œè€…è·èµæ•°+1
5. å‘é€ç‚¹èµé€šçŸ¥
6. Redis Setè®°å½•ç‚¹èµçŠ¶æ€

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "ç‚¹èµæˆåŠŸ",
  "data": {
    "likeCount": 1235
  }
}
```

**Redisè¾…åŠ©ï¼š**
- key: `user:note:likes:{userId}`
- å­˜å‚¨ç”¨æˆ·ç‚¹èµçš„ç¬”è®°IDé›†åˆï¼ˆSetï¼‰

---

### 3.5 å–æ¶ˆç‚¹èµç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.unlikeNote(id)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/notes/{id}/like`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
2. åˆ é™¤ç‚¹èµè®°å½•
3. ç¬”è®°ç‚¹èµæ•°-1
4. ä½œè€…è·èµæ•°-1
5. Redis Setåˆ é™¤ç‚¹èµçŠ¶æ€

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å–æ¶ˆç‚¹èµæˆåŠŸ",
  "data": {
    "likeCount": 1234
  }
}
```

---

### 3.6 æ”¶è—ç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.bookmarkNote(id)`

**æ¥å£åœ°å€ï¼š** `POST /api/notes/{id}/bookmark`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
2. æ’å…¥æ”¶è—è®°å½•ï¼ˆuser_favoritesè¡¨ï¼Œtype=1ï¼‰
3. ç¬”è®°æ”¶è—æ•°+1
4. ç”¨æˆ·æ”¶è—æ•°+1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "æ”¶è—æˆåŠŸ",
  "data": null
}
```

---

### 3.7 å–æ¶ˆæ”¶è—ç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.unbookmarkNote(id)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/notes/{id}/bookmark`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
2. åˆ é™¤æ”¶è—è®°å½•
3. ç¬”è®°æ”¶è—æ•°-1
4. ç”¨æˆ·æ”¶è—æ•°-1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å–æ¶ˆæ”¶è—æˆåŠŸ",
  "data": null
}
```

---

### 3.8 åˆ é™¤ç¬”è®°

**å‰ç«¯è°ƒç”¨ï¼š** `api.note.deleteNote(id)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/notes/{id}`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯ç¬”è®°å½’å±ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±çš„ç¬”è®°ï¼‰
2. è½¯åˆ é™¤ç¬”è®°ï¼ˆstatus=0ï¼‰
3. æ›´æ–°ç”¨æˆ·ç¬”è®°æ•°-1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ",
  "data": null
}
```

---

## å››ã€è¯„è®ºæ¨¡å— (CommentController)

### 4.1 è·å–ç¬”è®°è¯„è®ºåˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.comment.getNoteComments(noteId, pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/notes/{noteId}/comments`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
- URLå‚æ•°ï¼šnoteId
- Queryå‚æ•°ï¼špageNum, pageSize
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. åˆ†é¡µæŸ¥è¯¢é¡¶çº§è¯„è®ºï¼ˆparent_idä¸ºnullï¼‰
2. å…³è”æŸ¥è¯¢è¯„è®ºè€…ä¿¡æ¯
3. æŸ¥è¯¢æ¯æ¡è¯„è®ºçš„å‰3æ¡å›å¤
4. å¦‚æœå·²ç™»å½•ï¼ŒæŸ¥è¯¢ç”¨æˆ·ç‚¹èµçŠ¶æ€
5. æŒ‰ç‚¹èµæ•°å’Œæ—¶é—´æ’åº

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "10001",
        "author": "ç¾é£Ÿçˆ±å¥½è€…",
        "authorId": "2002",
        "avatar": "https://example.com/avatar2.jpg",
        "content": "çœ‹èµ·æ¥çœŸä¸é”™ï¼",
        "time": "2024-12-01 11:00:00",
        "likes": 45,
        "liked": false,
        "replyCount": 3,
        "replies": [
          {
            "id": "10002",
            "author": "ç¾é£Ÿæ¢åº—å°ç‹",
            "authorId": "2001",
            "avatar": "https://example.com/avatar.jpg",
            "content": "ç¡®å®å¾ˆå¥½åƒï¼",
            "time": "2024-12-01 11:05:00",
            "likes": 12,
            "liked": false
          }
        ]
      }
    ],
    "total": 128,
    "hasMore": true
  }
}
```

**SQLç¤ºä¾‹ï¼š**
```sql
-- æŸ¥è¯¢é¡¶çº§è¯„è®º
SELECT c.*, u.username, u.avatar
FROM note_comments c
LEFT JOIN users u ON c.user_id = u.id
WHERE c.note_id = ? AND c.parent_id IS NULL AND c.status = 1
ORDER BY c.like_count DESC, c.created_at DESC
LIMIT ?, ?

-- æŸ¥è¯¢å­å›å¤ï¼ˆæ¯æ¡è¯„è®ºæœ€å¤š3æ¡ï¼‰
SELECT c.*, u.username, u.avatar
FROM note_comments c
LEFT JOIN users u ON c.user_id = u.id
WHERE c.parent_id IN (?) AND c.status = 1
ORDER BY c.created_at ASC
LIMIT 3
```

---

### 4.2 å‘è¡¨è¯„è®º

**å‰ç«¯è°ƒç”¨ï¼š** `api.comment.postComment(noteId, data)`

**æ¥å£åœ°å€ï¼š** `POST /api/notes/{noteId}/comments`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "content": "è¯„è®ºå†…å®¹",
  "parentId": null
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `content` (String, å¿…å¡«): è¯„è®ºå†…å®¹ï¼Œ1-500å­—ç¬¦
- `parentId` (String, å¯é€‰): çˆ¶è¯„è®ºIDï¼Œå›å¤è¯„è®ºæ—¶å¡«å†™

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. å‚æ•°æ ¡éªŒ
2. æ•æ„Ÿè¯è¿‡æ»¤
3. æ’å…¥è¯„è®ºè®°å½•
4. ç¬”è®°è¯„è®ºæ•°+1
5. å¦‚æœæ˜¯å›å¤ï¼Œçˆ¶è¯„è®ºå›å¤æ•°+1
6. å‘é€è¯„è®ºé€šçŸ¥ç»™ç¬”è®°ä½œè€…
7. å¦‚æœæ˜¯å›å¤ï¼Œä¹Ÿé€šçŸ¥è¢«å›å¤çš„è¯„è®ºè€…

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "è¯„è®ºæˆåŠŸ",
  "data": {
    "commentId": "10001"
  }
}
```

---

### 4.3 ç‚¹èµè¯„è®º

**å‰ç«¯è°ƒç”¨ï¼š** `api.comment.likeComment(commentId)`

**æ¥å£åœ°å€ï¼š** `POST /api/comments/{commentId}/like`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
2. æ’å…¥ç‚¹èµè®°å½•ï¼ˆcomment_likesè¡¨ï¼‰
3. è¯„è®ºç‚¹èµæ•°+1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "ç‚¹èµæˆåŠŸ",
  "data": {
    "likeCount": 46
  }
}
```

---

### 4.4 å–æ¶ˆç‚¹èµè¯„è®º

**å‰ç«¯è°ƒç”¨ï¼š** `api.comment.unlikeComment(commentId)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/comments/{commentId}/like`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²ç‚¹èµ
2. åˆ é™¤ç‚¹èµè®°å½•
3. è¯„è®ºç‚¹èµæ•°-1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å–æ¶ˆç‚¹èµæˆåŠŸ",
  "data": {
    "likeCount": 45
  }
}
```

---

### 4.5 åˆ é™¤è¯„è®º

**å‰ç«¯è°ƒç”¨ï¼š** `api.comment.deleteComment(commentId)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/comments/{commentId}`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯è¯„è®ºå½’å±ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±çš„è¯„è®ºï¼‰
2. è½¯åˆ é™¤è¯„è®ºï¼ˆstatus=0ï¼‰
3. ç¬”è®°è¯„è®ºæ•°-1
4. å¦‚æœæœ‰å­è¯„è®ºï¼Œä¸€å¹¶è½¯åˆ é™¤

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "åˆ é™¤æˆåŠŸ",
  "data": null
}
```

---

## äº”ã€å•†å®¶æ¨¡å— (ShopController)

### 5.1 è·å–å•†å®¶åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.getShopList(params)`

**æ¥å£åœ°å€ï¼š** `GET /api/shops`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
```
category=ç¾é£Ÿ
&sortField=distance
&sortOrder=asc
&keyword=çƒ¤è‚‰
&latitude=30.2741
&longitude=120.1551
&pageNum=1
&pageSize=10
```

**å‚æ•°è¯´æ˜ï¼š**
- `category` (String, å¯é€‰): åˆ†ç±»åç§°
- `sortField` (String, å¯é€‰): æ’åºå­—æ®µ distance/popularity/rating/price
- `sortOrder` (String, å¯é€‰): æ’åºæ–¹å‘ asc/desc
- `keyword` (String, å¯é€‰): æœç´¢å…³é”®è¯
- `latitude` (Double, å¯é€‰): çº¬åº¦
- `longitude` (Double, å¯é€‰): ç»åº¦
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®åˆ†ç±»ç­›é€‰
2. æ ¹æ®å…³é”®è¯æœç´¢ï¼ˆå•†å®¶åç§°ã€æ ‡ç­¾ï¼‰
3. å¦‚æœæä¾›åæ ‡ï¼Œè®¡ç®—è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰
4. æ”¯æŒå¤šç§æ’åº
5. åˆ†é¡µè¿”å›

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "3001",
        "name": "è”¡é¦¬æ´ªæ¶›çƒ¤è‚‰Â·è€åŒ—äº¬é“œé”…æ¶®ç¾Šè‚‰",
        "image": "https://example.com/shop1.jpg",
        "rating": 4.8,
        "reviewCount": 1234,
        "tags": ["çƒ¤è‚‰", "ç«é”…", "äººæ°”æ¦œ"],
        "location": "æ‹±å¢…åŒº",
        "address": "ä¸Šå¡˜è·¯1035å·",
        "distance": "1.2km",
        "popularity": 9876,
        "averagePrice": 120.00,
        "latitude": 30.2751,
        "longitude": 120.1561
      }
    ],
    "total": 150,
    "hasMore": true
  }
}
```

**è·ç¦»è®¡ç®—ï¼ˆHaversineå…¬å¼ï¼‰ï¼š**
```java
public static double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
    double R = 6371; // åœ°çƒåŠå¾„ï¼ˆå…¬é‡Œï¼‰
    double dLat = Math.toRadians(lat2 - lat1);
    double dLon = Math.toRadians(lon2 - lon1);
    double a = Math.sin(dLat/2) * Math.sin(dLat/2) +
               Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2)) *
               Math.sin(dLon/2) * Math.sin(dLon/2);
    double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}
```

---

### 5.2 è·å–å•†å®¶è¯¦æƒ…

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.getShopDetail(id)`

**æ¥å£åœ°å€ï¼š** `GET /api/shops/{id}`

**å‰ç«¯è¯·æ±‚ï¼š**
- URLå‚æ•°ï¼šid
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŸ¥è¯¢å•†å®¶åŸºæœ¬ä¿¡æ¯
2. æŸ¥è¯¢å•†å®¶æ ‡ç­¾
3. å¦‚æœå·²ç™»å½•ï¼ŒæŸ¥è¯¢æ˜¯å¦å·²æ”¶è—
4. å¦‚æœæä¾›åæ ‡ï¼ˆå¯é€‰Queryå‚æ•°ï¼‰ï¼Œè®¡ç®—è·ç¦»

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "3001",
    "name": "è”¡é¦¬æ´ªæ¶›çƒ¤è‚‰Â·è€åŒ—äº¬é“œé”…æ¶®ç¾Šè‚‰",
    "headerImage": "https://example.com/shop1-header.jpg",
    "images": [
      "https://example.com/shop1-1.jpg",
      "https://example.com/shop1-2.jpg"
    ],
    "description": "æ­£å®—è€åŒ—äº¬çƒ¤è‚‰ï¼Œç²¾é€‰ä¼˜è´¨é£Ÿæ...",
    "rating": 4.6,
    "reviewCount": 1460,
    "tasteScore": 4.9,
    "environmentScore": 4.8,
    "serviceScore": 4.7,
    "address": "ä¸Šå¡˜è·¯1035å·ï¼ˆä¸­å›½å·¥å•†é“¶è¡Œæ—ï¼‰",
    "businessHours": "11:30 - 03:00",
    "phone": "0571-12345678",
    "averagePrice": 120.00,
    "tags": ["çƒ¤è‚‰", "ç«é”…", "äººæ°”æ¦œ", "åœè½¦æ–¹ä¾¿"],
    "isFavorited": false,
    "latitude": 30.2751,
    "longitude": 120.1561,
    "distance": "1.2km"
  }
}
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- å•†å®¶åŸºæœ¬ä¿¡æ¯ç¼“å­˜1å°æ—¶
- key: `shop:info:{shopId}`

---

### 5.3 è·å–å•†å®¶è¯„ä»·åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.getShopReviews(shopId, pageNum, pageSize, sortBy)`

**æ¥å£åœ°å€ï¼š** `GET /api/shops/{shopId}/reviews`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
- URLå‚æ•°ï¼šshopId
- Queryå‚æ•°ï¼špageNum, pageSize, sortBy
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**å‚æ•°è¯´æ˜ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- `sortBy` (String): æ’åºæ–¹å¼ latest=æœ€æ–°, rating=è¯„åˆ†

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. åˆ†é¡µæŸ¥è¯¢è¯„ä»·
2. å…³è”æŸ¥è¯¢è¯„ä»·è€…ä¿¡æ¯
3. æŒ‰sortByæ’åº

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "20001",
        "author": "ç¾é£Ÿçˆ±å¥½è€…",
        "authorId": "2002",
        "avatar": "https://example.com/avatar2.jpg",
        "rating": 5.0,
        "tasteScore": 5.0,
        "environmentScore": 4.5,
        "serviceScore": 5.0,
        "date": "2024-11-30",
        "content": "å‘³é“éå¸¸æ£’ï¼Œç¯å¢ƒä¹Ÿå¾ˆå¥½ï¼",
        "images": [
          "https://example.com/review1-1.jpg",
          "https://example.com/review1-2.jpg"
        ],
        "likeCount": 23
      }
    ],
    "total": 1460,
    "hasMore": true
  }
}
```

---

### 5.4 å‘è¡¨å•†å®¶è¯„ä»·

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.postShopReview(shopId, data)`

**æ¥å£åœ°å€ï¼š** `POST /api/shops/{shopId}/reviews`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "rating": 5.0,
  "tasteScore": 5.0,
  "environmentScore": 4.5,
  "serviceScore": 5.0,
  "content": "å‘³é“éå¸¸æ£’ï¼",
  "images": [
    "https://example.com/review1.jpg",
    "https://example.com/review2.jpg"
  ]
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `rating` (Double, å¿…å¡«): æ€»ä½“è¯„åˆ† 1.0-5.0
- `tasteScore` (Double, å¿…å¡«): å£å‘³è¯„åˆ† 1.0-5.0
- `environmentScore` (Double, å¿…å¡«): ç¯å¢ƒè¯„åˆ† 1.0-5.0
- `serviceScore` (Double, å¿…å¡«): æœåŠ¡è¯„åˆ† 1.0-5.0
- `content` (String, å¿…å¡«): è¯„ä»·å†…å®¹ï¼Œ10-500å­—ç¬¦
- `images` (Array, å¯é€‰): å›¾ç‰‡æ•°ç»„ï¼Œæœ€å¤š9å¼ 

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²è¯„ä»·è¿‡ï¼ˆä¸€ä¸ªç”¨æˆ·åªèƒ½è¯„ä»·ä¸€æ¬¡ï¼‰
2. æ’å…¥è¯„ä»·è®°å½•
3. é‡æ–°è®¡ç®—å•†å®¶è¯„åˆ†ï¼ˆå¹³å‡å€¼ï¼‰
4. æ›´æ–°å•†å®¶è¯„ä»·æ•°+1
5. æ¸…é™¤å•†å®¶è¯¦æƒ…ç¼“å­˜

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "è¯„ä»·æˆåŠŸ",
  "data": {
    "reviewId": "20001"
  }
}
```

**è¯„åˆ†è®¡ç®—ï¼š**
```java
public void recalculateRating(Long shopId) {
    List<ShopReview> reviews = reviewService.getByShopId(shopId);
    
    double avgRating = reviews.stream()
        .mapToDouble(ShopReview::getRating)
        .average()
        .orElse(0.0);
    
    double avgTaste = reviews.stream()
        .mapToDouble(ShopReview::getTasteScore)
        .average()
        .orElse(0.0);
    
    // æ›´æ–°å•†å®¶è¯„åˆ†
    Shop shop = new Shop();
    shop.setId(shopId);
    shop.setRating(BigDecimal.valueOf(avgRating));
    shop.setTasteScore(BigDecimal.valueOf(avgTaste));
    shopService.updateById(shop);
    
    // æ¸…é™¤ç¼“å­˜
    redisUtil.delete("shop:info:" + shopId);
}
```

---

### 5.5 æ”¶è—å•†å®¶

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.favoriteShop(shopId)`

**æ¥å£åœ°å€ï¼š** `POST /api/shops/{shopId}/favorite`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
2. æ’å…¥æ”¶è—è®°å½•ï¼ˆuser_favoritesè¡¨ï¼Œtype=2ï¼‰
3. ç”¨æˆ·æ”¶è—æ•°+1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "æ”¶è—æˆåŠŸ",
  "data": null
}
```

---

### 5.6 å–æ¶ˆæ”¶è—å•†å®¶

**å‰ç«¯è°ƒç”¨ï¼š** `api.shop.unfavoriteShop(shopId)`

**æ¥å£åœ°å€ï¼š** `DELETE /api/shops/{shopId}/favorite`

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
2. åˆ é™¤æ”¶è—è®°å½•
3. ç”¨æˆ·æ”¶è—æ•°-1

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å–æ¶ˆæ”¶è—æˆåŠŸ",
  "data": null
}
```

---

## å…­ã€æ¶ˆæ¯æ¨¡å— (MessageController)

### 6.1 è·å–èŠå¤©åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.getChatList()`

**æ¥å£åœ°å€ï¼š** `GET /api/messages/chats`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— å‚æ•°
- éœ€è¦Authorizationå¤´

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯
2. å…³è”æŸ¥è¯¢å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯
3. æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´å€’åº

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "5001",
      "name": "å°çº¢",
      "userId": "2002",
      "avatar": "https://example.com/avatar2.jpg",
      "lastMessage": "è¿™å®¶åº—çœŸçš„è¶…çº§å¥½åƒï¼",
      "time": "10:30",
      "unread": 2,
      "online": true
    }
  ]
}
```

**SQLç¤ºä¾‹ï¼š**
```sql
SELECT cs.*, u.username, u.avatar, u.online_status
FROM chat_sessions cs
LEFT JOIN users u ON cs.other_user_id = u.id
WHERE cs.user_id = ?
ORDER BY cs.last_message_time DESC
```

---

### 6.2 è·å–èŠå¤©æ¶ˆæ¯

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.getChatMessages(sessionId, pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/messages/chats/{sessionId}`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
- URLå‚æ•°ï¼šsessionId
- Queryå‚æ•°ï¼špageNum, pageSize

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯ä¼šè¯å½’å±
2. åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯
3. æŒ‰æ—¶é—´å€’åºï¼ˆå‰ç«¯ä¼šåè½¬æ˜¾ç¤ºï¼‰
4. æ ‡è®°æ¶ˆæ¯ä¸ºå·²è¯»

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "60001",
        "fromUserId": "2002",
        "toUserId": "2001",
        "content": "è¿™å®¶åº—çœŸçš„è¶…çº§å¥½åƒï¼",
        "messageType": 1,
        "isRead": true,
        "createdAt": "2024-12-03 10:30:00"
      }
    ],
    "hasMore": false
  }
}
```

---

### 6.3 å‘é€æ¶ˆæ¯

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.sendMessage(userId, data)`

**æ¥å£åœ°å€ï¼š** `POST /api/messages/chats/{userId}`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "content": "ä½ å¥½ï¼",
  "messageType": 1
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `content` (String, å¿…å¡«): æ¶ˆæ¯å†…å®¹
- `messageType` (Integer, å¿…å¡«): æ¶ˆæ¯ç±»å‹ 1=æ–‡æœ¬ï¼Œ2=å›¾ç‰‡ï¼Œ3=è¯­éŸ³

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰ï¼š**
1. æ£€æŸ¥æˆ–åˆ›å»ºä¼šè¯
2. æ’å…¥æ¶ˆæ¯è®°å½•
3. æ›´æ–°ä¼šè¯æœ€åæ¶ˆæ¯æ—¶é—´å’Œå†…å®¹
4. å¢åŠ å¯¹æ–¹æœªè¯»æ•°
5. å¦‚æœä½¿ç”¨WebSocketï¼Œå®æ—¶æ¨é€ç»™å¯¹æ–¹

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "å‘é€æˆåŠŸ",
  "data": {
    "messageId": "60001"
  }
}
```

**WebSocketæ¨é€ï¼ˆå¯é€‰ï¼‰ï¼š**
```java
public void sendMessage(Long fromUserId, Long toUserId, String content) {
    // ä¿å­˜æ¶ˆæ¯
    ChatMessage message = new ChatMessage();
    message.setFromUserId(fromUserId);
    message.setToUserId(toUserId);
    message.setContent(content);
    messageService.save(message);
    
    // é€šè¿‡WebSocketæ¨é€
    if (webSocketService.isOnline(toUserId)) {
        webSocketService.sendMessage(toUserId, message);
    }
}
```

---

### 6.4 è·å–ç³»ç»Ÿé€šçŸ¥åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.getNotices(pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/messages/notices`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤20

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. åˆ†é¡µæŸ¥è¯¢é€šçŸ¥
2. å…³è”æŸ¥è¯¢è§¦å‘ç”¨æˆ·ä¿¡æ¯
3. æŒ‰æ—¶é—´å€’åº
4. è¿”å›æœªè¯»æ•°é‡

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "70001",
        "user": "ç¾é£Ÿè¾¾äºº",
        "userId": "2003",
        "avatar": "https://example.com/avatar3.jpg",
        "action": "ç‚¹èµäº†ä½ çš„ç¬”è®°",
        "time": "5åˆ†é’Ÿå‰",
        "icon": "â¤ï¸",
        "type": "like",
        "image": "https://example.com/note.jpg",
        "targetId": "1001",
        "isRead": false
      },
      {
        "id": "70002",
        "user": "æ¢åº—å°èƒ½æ‰‹",
        "userId": "2004",
        "avatar": "https://example.com/avatar4.jpg",
        "action": "è¯„è®ºäº†ä½ çš„ç¬”è®°",
        "time": "10åˆ†é’Ÿå‰",
        "icon": "ğŸ’¬",
        "type": "comment",
        "image": "https://example.com/note2.jpg",
        "targetId": "1002",
        "isRead": false
      },
      {
        "id": "70003",
        "user": "ç¾é£Ÿåˆ†äº«å®¶",
        "userId": "2005",
        "avatar": "https://example.com/avatar5.jpg",
        "action": "å…³æ³¨äº†ä½ ",
        "time": "1å°æ—¶å‰",
        "icon": "ğŸ‘¤",
        "type": "follow",
        "image": null,
        "targetId": null,
        "isRead": true
      }
    ],
    "total": 50,
    "unreadCount": 12,
    "hasMore": true
  }
}
```

**é€šçŸ¥ç±»å‹æ˜ å°„ï¼š**
```java
public class NoticeType {
    public static final String LIKE = "like";         // ç‚¹èµç¬”è®°
    public static final String COMMENT = "comment";   // è¯„è®ºç¬”è®°
    public static final String FOLLOW = "follow";     // å…³æ³¨
}
```

---

### 6.5 æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.markNoticesRead(noticeIds)`

**æ¥å£åœ°å€ï¼š** `PUT /api/messages/notices/read`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "noticeIds": ["70001", "70002"]
}
```

**å‚æ•°è¯´æ˜ï¼š**
- `noticeIds` (Array): é€šçŸ¥IDæ•°ç»„ï¼Œç©ºæ•°ç»„è¡¨ç¤ºå…¨éƒ¨å·²è¯»

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. å¦‚æœnoticeIdsä¸ºç©ºï¼Œæ ‡è®°æ‰€æœ‰é€šçŸ¥ä¸ºå·²è¯»
2. å¦åˆ™ï¼Œæ ‡è®°æŒ‡å®šé€šçŸ¥ä¸ºå·²è¯»
3. æ›´æ–°is_readå­—æ®µ

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "æ ‡è®°æˆåŠŸ",
  "data": null
}
```

---

### 6.6 è·å–æœªè¯»æ¶ˆæ¯æ•°

**å‰ç«¯è°ƒç”¨ï¼š** `api.message.getUnreadCount()`

**æ¥å£åœ°å€ï¼š** `GET /api/messages/unread-count`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— å‚æ•°
- éœ€è¦Authorizationå¤´

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. ç»Ÿè®¡æœªè¯»èŠå¤©æ¶ˆæ¯æ•°
2. ç»Ÿè®¡æœªè¯»ç³»ç»Ÿé€šçŸ¥æ•°
3. è¿”å›æ€»è®¡

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "chatUnread": 5,
    "noticeUnread": 12,
    "totalUnread": 17
  }
}
```

---

## ä¸ƒã€ä¸Šä¼ æ¨¡å— (UploadController)

### 7.1 ä¸Šä¼ å•å¼ å›¾ç‰‡

**å‰ç«¯è°ƒç”¨ï¼š** `api.upload.uploadImage(filePath)`

**æ¥å£åœ°å€ï¼š** `POST /api/upload/image`

**å‰ç«¯è¯·æ±‚ï¼š**
- Content-Type: `multipart/form-data`
- å‚æ•°åï¼š`file`
- éœ€è¦Authorizationå¤´

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯æ–‡ä»¶ç±»å‹ï¼ˆä»…æ”¯æŒJPGã€PNGï¼‰
2. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆä¸è¶…è¿‡5MBï¼‰
3. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆUUID + æ‰©å±•åï¼‰
4. ä¸Šä¼ åˆ°OSSæˆ–æœ¬åœ°å­˜å‚¨
5. è¿”å›è®¿é—®URL

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "ä¸Šä¼ æˆåŠŸ",
  "data": {
    "url": "https://example.com/uploads/image123.jpg"
  }
}
```

**å®ç°è¦ç‚¹ï¼š**
```java
@PostMapping("/image")
public Result<UploadResponse> uploadImage(@RequestParam("file") MultipartFile file) {
    // 1. éªŒè¯æ–‡ä»¶
    if (file.isEmpty()) {
        return Result.error(400, "æ–‡ä»¶ä¸èƒ½ä¸ºç©º");
    }
    
    String contentType = file.getContentType();
    if (!"image/jpeg".equals(contentType) && !"image/png".equals(contentType)) {
        return Result.error(400, "ä»…æ”¯æŒJPGã€PNGæ ¼å¼");
    }
    
    if (file.getSize() > 5 * 1024 * 1024) {
        return Result.error(400, "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB");
    }
    
    // 2. ç”Ÿæˆæ–‡ä»¶å
    String originalFilename = file.getOriginalFilename();
    String ext = originalFilename.substring(originalFilename.lastIndexOf("."));
    String fileName = UUID.randomUUID().toString() + ext;
    
    // 3. ä¸Šä¼ åˆ°OSS
    String url = ossService.upload(file.getInputStream(), fileName);
    
    // 4. è¿”å›URL
    UploadResponse response = new UploadResponse();
    response.setUrl(url);
    
    return Result.success(response);
}
```

---

### 7.2 æ‰¹é‡ä¸Šä¼ å›¾ç‰‡

**å‰ç«¯è°ƒç”¨ï¼š** `api.upload.uploadImages(filePaths)`

**è¯´æ˜ï¼š** å‰ç«¯é€šè¿‡å¹¶å‘è°ƒç”¨å¤šæ¬¡uploadImageå®ç°æ‰¹é‡ä¸Šä¼ ï¼Œåç«¯æ— éœ€é¢å¤–æ¥å£

---

## å…«ã€å…¬å…±æ¨¡å— (CommonController)

### 8.1 è·å–åˆ†ç±»åˆ—è¡¨

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.getCategories()`

**æ¥å£åœ°å€ï¼š** `GET /api/categories`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— å‚æ•°
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„åˆ†ç±»
2. æŒ‰æ’åºå­—æ®µæ’åº

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "name": "ç¾é£Ÿ",
      "icon": "ğŸœ",
      "color": "#FFD166"
    },
    {
      "id": 2,
      "name": "KTV",
      "icon": "ğŸ¤",
      "color": "#EF476F"
    },
    {
      "id": 3,
      "name": "ç”µå½±",
      "icon": "ğŸ¬",
      "color": "#06D6A0"
    }
  ]
}
```

**ç¼“å­˜ç­–ç•¥ï¼š**
- åˆ†ç±»æ•°æ®å¾ˆå°‘å˜åŠ¨ï¼Œå¯ç¼“å­˜1å¤©
- key: `categories:all`

---

### 8.2 è·å–çƒ­é—¨è¯é¢˜

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.getHotTopics(pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/topics/hot`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æŒ‰çƒ­åº¦æ’åºï¼ˆå‚ä¸ç¬”è®°æ•°ã€æµè§ˆæ•°ï¼‰
2. åˆ†é¡µè¿”å›

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": "8001",
        "name": "æ­å·ç¾é£Ÿæ¢åº—",
        "description": "åˆ†äº«æ­å·åœ°åŒºçš„ç¾é£Ÿæ¢åº—ä½“éªŒ",
        "coverImage": "https://example.com/topic1.jpg",
        "noteCount": 12345,
        "viewCount": 567890,
        "isHot": true
      }
    ],
    "hasMore": true
  }
}
```

---

### 8.3 æœç´¢è¯é¢˜

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.searchTopics(keyword, pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/topics/search`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `keyword` (String): æœç´¢å…³é”®è¯
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®å…³é”®è¯æœç´¢è¯é¢˜åç§°å’Œæè¿°
2. åˆ†é¡µè¿”å›

**åç«¯è¿”å›æ•°æ®ï¼š** åŒ8.2

---

### 8.4 è·å–é™„è¿‘å•†å®¶

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.getNearbyShops(params)`

**æ¥å£åœ°å€ï¼š** `GET /api/map/nearby-shops`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
```
latitude=30.2741
&longitude=120.1551
&category=ç¾é£Ÿ
&radius=5000
```

**å‚æ•°è¯´æ˜ï¼š**
- `latitude` (Double, å¿…å¡«): çº¬åº¦
- `longitude` (Double, å¿…å¡«): ç»åº¦
- `category` (String, å¯é€‰): åˆ†ç±»
- `radius` (Integer, å¯é€‰): æœç´¢åŠå¾„ï¼ˆç±³ï¼‰ï¼Œé»˜è®¤5000
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. è®¡ç®—èŒƒå›´å†…çš„å•†å®¶ï¼ˆä½¿ç”¨åœ°ç†ä½ç½®ç´¢å¼•ï¼‰
2. è®¡ç®—è·ç¦»
3. æŒ‰è·ç¦»æ’åº

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "3001",
      "name": "è”¡é¦¬æ´ªæ¶›çƒ¤è‚‰",
      "rating": 4.6,
      "reviewCount": 1460,
      "distance": "170m",
      "image": "https://example.com/shop1.jpg",
      "latitude": 30.2751,
      "longitude": 120.1561,
      "tags": ["çƒ¤è‚‰", "ç«é”…"]
    }
  ]
}
```

---

### 8.5 ç»¼åˆæœç´¢

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.search(keyword, type, pageNum, pageSize)`

**æ¥å£åœ°å€ï¼š** `GET /api/search`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `keyword` (String): æœç´¢å…³é”®è¯
- `type` (String): æœç´¢ç±»å‹ all/note/shop
- `pageNum` (Integer): é¡µç ï¼Œé»˜è®¤1
- `pageSize` (Integer): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®typeæœç´¢ä¸åŒçš„å†…å®¹
2. å¦‚æœtype=allï¼ŒåŒæ—¶æœç´¢ç¬”è®°å’Œå•†å®¶
3. æ”¯æŒElasticsearchå…¨æ–‡æœç´¢ï¼ˆå¯é€‰ï¼‰

**åç«¯è¿”å›æ•°æ®ï¼ˆtype=allï¼‰ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "notes": {
      "list": [
        {
          "id": "1001",
          "image": "https://example.com/note1.jpg",
          "title": "æ­å·è¶…å¥½åƒçš„çƒ¤è‚‰åº—ï¼",
          "author": "ç¾é£Ÿæ¢åº—å°ç‹",
          "likes": 1234
        }
      ],
      "total": 50
    },
    "shops": {
      "list": [
        {
          "id": "3001",
          "name": "è”¡é¦¬æ´ªæ¶›çƒ¤è‚‰",
          "image": "https://example.com/shop1.jpg",
          "rating": 4.6,
          "reviewCount": 1460
        }
      ],
      "total": 30
    }
  }
}
```

**åç«¯è¿”å›æ•°æ®ï¼ˆtype=noteæˆ–shopï¼‰ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [...],
    "total": 50,
    "pageNum": 1,
    "pageSize": 10,
    "hasMore": true
  }
}
```

---

### 8.6 è·å–æœç´¢å»ºè®®

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.getSearchSuggest(keyword)`

**æ¥å£åœ°å€ï¼š** `GET /api/search/suggest`

**å‰ç«¯è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰ï¼š**
- `keyword` (String): æœç´¢å…³é”®è¯
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. æ ¹æ®å…³é”®è¯å‰ç¼€åŒ¹é…
2. è¿”å›çƒ­é—¨æœç´¢è¯
3. æœ€å¤šè¿”å›10æ¡

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "suggestions": [
      "çƒ¤è‚‰",
      "çƒ¤é±¼",
      "çƒ¤ä¸²"
    ]
  }
}
```

---

### 8.7 è·å–çƒ­é—¨æœç´¢

**å‰ç«¯è°ƒç”¨ï¼š** `api.common.getHotSearch()`

**æ¥å£åœ°å€ï¼š** `GET /api/search/hot`

**å‰ç«¯è¯·æ±‚ï¼š**
- æ— å‚æ•°
- **æ³¨æ„ï¼šå‰ç«¯æ ‡è®°ä¸ºnoAuth:trueï¼Œæ— éœ€token**

**åç«¯ä¸šåŠ¡é€»è¾‘ï¼š**
1. è¿”å›çƒ­é—¨æœç´¢è¯ï¼ˆæ ¹æ®æœç´¢é¢‘ç‡ç»Ÿè®¡ï¼‰
2. æœ€å¤šè¿”å›10æ¡

**åç«¯è¿”å›æ•°æ®ï¼š**
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hotWords": [
      "ç«é”…",
      "çƒ§çƒ¤",
      "æ—¥æ–™",
      "è¥¿é¤"
    ]
  }
}
```

---

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. JWTè®¤è¯

**JwtUtilå·¥å…·ç±»ï¼š**
```java
@Component
public class JwtUtil {
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration; // 604800ç§’ = 7å¤©
    
    public String generateToken(Long userId) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration * 1000);
        
        return Jwts.builder()
            .setSubject(userId.toString())
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    public Long getUserIdFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
        
        return Long.parseLong(claims.getSubject());
    }
    
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    public long getExpireTime(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
        
        Date expiration = claims.getExpiration();
        return (expiration.getTime() - System.currentTimeMillis()) / 1000;
    }
}
```

**è®¤è¯æ‹¦æˆªå™¨ï¼š**
```java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private RedisUtil redisUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String token = request.getHeader("Authorization");
        
        if (token == null || !token.startsWith("Bearer ")) {
            throw new BusinessException(401, "æœªç™»å½•");
        }
        
        token = token.substring(7);
        
        // æ£€æŸ¥é»‘åå•
        if (redisUtil.hasKey("token:blacklist:" + token)) {
            throw new BusinessException(401, "Tokenå·²å¤±æ•ˆ");
        }
        
        // éªŒè¯Token
        if (!jwtUtil.validateToken(token)) {
            throw new BusinessException(401, "Tokenæ— æ•ˆ");
        }
        
        // è§£æç”¨æˆ·IDå¹¶å­˜å…¥ä¸Šä¸‹æ–‡
        Long userId = jwtUtil.getUserIdFromToken(token);
        UserContext.setUserId(userId);
        
        return true;
    }
}
```

---

### 2. ç»Ÿä¸€å“åº”å°è£…

**Resultç±»ï¼š**
```java
@Data
public class Result<T> {
    private Integer code;
    private String message;
    private T data;
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        return result;
    }
    
    public static <T> Result<T> success(String message) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage(message);
        return result;
    }
    
    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        return result;
    }
}
```

**PageResultç±»ï¼š**
```java
@Data
public class PageResult<T> {
    private List<T> list;
    private Integer total;
    private Integer pageNum;
    private Integer pageSize;
    private Boolean hasMore;
    
    public static <T> PageResult<T> of(List<T> list, Integer total, Integer pageNum, Integer pageSize) {
        PageResult<T> result = new PageResult<>();
        result.setList(list);
        result.setTotal(total);
        result.setPageNum(pageNum);
        result.setPageSize(pageSize);
        result.setHasMore(pageNum * pageSize < total);
        return result;
    }
}
```

---

### 3. å…¨å±€å¼‚å¸¸å¤„ç†

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<?> handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public Result<?> handleValidationException(MethodArgumentNotValidException e) {
        String message = e.getBindingResult().getFieldError().getDefaultMessage();
        return Result.error(400, message);
    }
    
    @ExceptionHandler(Exception.class)
    public Result<?> handleException(Exception e) {
        log.error("ç³»ç»Ÿå¼‚å¸¸", e);
        return Result.error(500, "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

### 4. Rediså·¥å…·ç±»

```java
@Component
public class RedisUtil {
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    public void set(String key, String value, long timeout) {
        redisTemplate.opsForValue().set(key, value, timeout, TimeUnit.SECONDS);
    }
    
    public String get(String key) {
        return redisTemplate.opsForValue().get(key);
    }
    
    public <T> T get(String key, Class<T> clazz) {
        String json = redisTemplate.opsForValue().get(key);
        return JSON.parseObject(json, clazz);
    }
    
    public <T> void set(String key, T value, long timeout) {
        String json = JSON.toJSONString(value);
        redisTemplate.opsForValue().set(key, json, timeout, TimeUnit.SECONDS);
    }
    
    public void delete(String key) {
        redisTemplate.delete(key);
    }
    
    public boolean hasKey(String key) {
        return Boolean.TRUE.equals(redisTemplate.hasKey(key));
    }
    
    // Setæ“ä½œ
    public void sAdd(String key, String... values) {
        redisTemplate.opsForSet().add(key, values);
    }
    
    public boolean sIsMember(String key, String value) {
        return Boolean.TRUE.equals(redisTemplate.opsForSet().isMember(key, value));
    }
    
    public void sRemove(String key, String value) {
        redisTemplate.opsForSet().remove(key, value);
    }
}
```

---

## é…ç½®æ–‡ä»¶

**application.yml:**
```yaml
server:
  port: 8080

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/business_reviews?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: your_password
    
  redis:
    host: localhost
    port: 6379
    password:
    database: 0
    
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 20MB

mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.businessreviews.entity
  configuration:
    map-underscore-to-camel-case: true
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

jwt:
  secret: your-secret-key-here-make-it-long-and-random
  expiration: 604800  # 7å¤©ï¼ˆç§’ï¼‰

sms:
  aliyun:
    accessKeyId: ${SMS_ACCESS_KEY_ID}
    accessKeySecret: ${SMS_ACCESS_KEY_SECRET}
    signName: ç¾é£Ÿç‚¹è¯„
    templateCode: SMS_123456789

# OSSé…ç½®ï¼ˆé˜¿é‡Œäº‘ï¼‰
aliyun:
  oss:
    endpoint: oss-cn-hangzhou.aliyuncs.com
    accessKeyId: ${ALIYUN_ACCESS_KEY_ID}
    accessKeySecret: ${ALIYUN_ACCESS_KEY_SECRET}
    bucketName: business-reviews
```

---

## é¡¹ç›®æ¨¡å—åˆ’åˆ†

ä¸ºä½¿é¡¹ç›®ç»“æ„æ›´åŠ æ¸…æ™°ï¼ŒæŒ‰ä¸šåŠ¡åŠŸèƒ½è¿›è¡Œæ¨¡å—åŒ–æ¢³ç†ï¼Œå¹¶ç»™å‡ºå½“å‰ä»£ç çš„å¯¹åº”å…³ç³»ï¼ˆåŒ…ä¸ç±»ï¼‰ï¼š

- è®¤è¯æ¨¡å—ï¼ˆAuthï¼‰
  - æ§åˆ¶å™¨ï¼š`AuthController`
  - ä¸šåŠ¡ï¼š`AuthService`ã€`AuthServiceImpl`
  - å·¥å…·ä¸æ‹¦æˆªï¼š`JwtUtil`ã€`AuthInterceptor`
  - è¯·æ±‚/å“åº”ï¼š`LoginByCodeRequest`ã€`SendCodeRequest`ã€`OAuthLoginRequest`ã€`LoginResponse`
  - å®ä½“/Mapperï¼š`VerificationCode`ã€`VerificationCodeMapper`

- ç”¨æˆ·æ¨¡å—ï¼ˆUserï¼‰
  - æ§åˆ¶å™¨ï¼š`UserController`
  - ä¸šåŠ¡ï¼š`UserService`ã€`UserServiceImpl`
  - è¯·æ±‚/å“åº”ï¼š`UpdateUserInfoRequest`ã€`ChangePasswordRequest`ã€`FollowRequest`ã€`UserInfoResponse`ã€`UserProfileResponse`ã€`UserItemResponse`ã€`FavoriteItemResponse`ã€`HistoryItemResponse`
  - å®ä½“/Mapperï¼š`User`ã€`UserStats`ã€`UserFollow`ã€`UserFavorite`ã€`BrowseHistory` åŠå¯¹åº” Mapper

- ç¬”è®°æ¨¡å—ï¼ˆNoteï¼‰
  - æ§åˆ¶å™¨ï¼š`NoteController`
  - ä¸šåŠ¡ï¼š`NoteService`ã€`NoteServiceImpl`
  - è¯·æ±‚/å“åº”ï¼š`PublishNoteRequest`ã€`NoteDetailResponse`ã€`NoteItemResponse`
  - å®ä½“/Mapperï¼š`Note`ã€`NoteTag`ã€`NoteTopic`ã€`UserNoteLike` åŠå¯¹åº” Mapper

- è¯„è®ºæ¨¡å—ï¼ˆCommentï¼‰
  - æ§åˆ¶å™¨ï¼š`CommentController`
  - ä¸šåŠ¡ï¼š`CommentService`ã€`CommentServiceImpl`
  - è¯·æ±‚/å“åº”ï¼š`AddCommentRequest`ã€`CommentResponse`
  - å®ä½“/Mapperï¼š`Comment`ã€`CommentLike`ã€`NoteComment` åŠå¯¹åº” Mapper

- å•†å®¶æ¨¡å—ï¼ˆShopï¼‰
  - æ§åˆ¶å™¨ï¼š`ShopController`
  - ä¸šåŠ¡ï¼š`ShopService`ã€`ShopServiceImpl`
  - è¯·æ±‚/å“åº”ï¼š`PostShopReviewRequest`ã€`ShopDetailResponse`ã€`ShopItemResponse`ã€`ShopReviewResponse`
  - å®ä½“/Mapperï¼š`Shop`ã€`ShopTag`ã€`ShopReview` åŠå¯¹åº” Mapper

- æ¶ˆæ¯ä¸é€šçŸ¥æ¨¡å—ï¼ˆMessageï¼‰
  - æ§åˆ¶å™¨ï¼š`MessageController`
  - ä¸šåŠ¡ï¼š`MessageService`ã€`MessageServiceImpl`
  - è¯·æ±‚/å“åº”ï¼š`SendMessageRequest`ã€`MarkNoticesReadRequest`ã€`ConversationResponse`ã€`MessageResponse`ã€`NotificationResponse`
  - å®ä½“/Mapperï¼š`ChatMessage`ã€`ChatSession`ã€`Notification`ã€`SystemNotice` åŠå¯¹åº” Mapper

- ä¸Šä¼ æ¨¡å—ï¼ˆUploadï¼‰
  - æ§åˆ¶å™¨ï¼š`UploadController`
  - ä¸šåŠ¡ï¼š`UploadService`ã€`UploadServiceImpl`ã€`OssService`ã€`OssServiceImpl`
  - é…ç½®ï¼š`OssConfig`

- å…¬å…±æ¨¡å—ï¼ˆCommonï¼‰
  - æ§åˆ¶å™¨ï¼š`CommonController`
  - ä¸šåŠ¡ï¼š`CommonService`ã€`CommonServiceImpl`
  - å·¥å…·ï¼š`RedisUtil`ã€`TimeUtil`ã€`DistanceUtil`

- åŸºç¡€è®¾æ–½ï¼ˆInfrastructureï¼‰
  - é…ç½®ï¼š`AsyncConfig`ã€`CorsConfig`ã€`MybatisPlusConfig`ã€`RedisConfig`
  - å¯åŠ¨ï¼š`BusinessReviewsApplication`
  - ç»Ÿä¸€å¼‚å¸¸ï¼š`GlobalExceptionHandler`ã€`BusinessException`
  - ä¸Šä¸‹æ–‡ï¼š`UserContext`

è¯´æ˜ï¼šä»¥ä¸Šä¸ºé€»è¾‘æ¨¡å—åˆ’åˆ†ä¸å½“å‰ä»£ç æ˜ å°„ï¼Œåç»­å¦‚éœ€è¿›ä¸€æ­¥ç‰©ç†æ‹†åˆ†ï¼ˆä¾‹å¦‚ Maven å¤šæ¨¡å—æˆ–åŒ…ç»“æ„è°ƒæ•´ï¼‰ï¼Œå¯æŒ‰æ­¤æ¸…å•é€æ­¥è¿ç§»ã€‚

## é¡¹ç›®æ–‡æ¡£ç´¢å¼•

å°†åç«¯è¯´æ˜æ–‡æ¡£ä¸é¡¹ç›®æ ¹ç›®å½•ä¸­çš„å·²æœ‰æ–‡æ¡£è¿›è¡Œç»Ÿä¸€ç´¢å¼•ï¼Œä¾¿äºæŸ¥é˜…ï¼š

- æ ¹ç›®å½•æ–‡æ¡£ï¼ˆC:\\Users\\ç¨‹æ˜æ°\\Desktop\\business-reviews\\ï¼‰
  - ã€Šå‰åç«¯è”è°ƒæµ‹è¯•è¯´æ˜.mdã€‹
  - ã€ŠåŠŸèƒ½å®ç°è¯´æ˜.mdã€‹
  - ã€Šå¤´åƒurl.txtã€‹
  - ã€Šå¤´åƒä¸Šä¼ åŠŸèƒ½è¯´æ˜.mdã€‹
  - ã€Šæ–°ç”¨æˆ·éšæœºå¤´åƒåŠŸèƒ½è¯´æ˜.mdã€‹
  - ã€Šç”¨æˆ·ä¸å­˜åœ¨é—®é¢˜è§£å†³æ–¹æ¡ˆ.mdã€‹
  - ã€Šç¼“å­˜æ··ä¹±é—®é¢˜å·²ä¿®å¤.mdã€‹
  - ã€Šé—®é¢˜å·²ä¿®å¤è¯´æ˜.mdã€‹
  - ã€Šé—®é¢˜æ’æŸ¥æ­¥éª¤.mdã€‹
  - ã€Šé˜¿é‡Œäº‘OSSé…ç½®æŒ‡å—.mdã€‹

- åç«¯é¡¹ç›®æ–‡æ¡£ï¼ˆC:\\Users\\ç¨‹æ˜æ°\\Desktop\\business-reviews\\backend-business-reviews\\ï¼‰
  - ã€ŠAPIä½¿ç”¨è¯´æ˜.mdã€‹
  - ã€Šå‰ç«¯æ¥å£æ–‡æ¡£.mdã€‹
  - ã€Šåç«¯æ¥å£æ–‡æ¡£.mdã€‹ï¼ˆå½“å‰æ–‡æ¡£ï¼‰
  - ã€Šæ•°æ®åº“è®¾è®¡.mdã€‹

ä¸Šè¿°æ–‡æ¡£ä¸ºè”è°ƒã€é—®é¢˜æ’æŸ¥ã€åŠŸèƒ½è¯´æ˜ä¸éƒ¨ç½²è¿ç»´çš„å‚è€ƒææ–™ï¼Œå»ºè®®ä¸æœ¬æ–‡çš„æ¥å£è¯´æ˜ä¸€èµ·ä½¿ç”¨ï¼Œä»¥è·å¾—å®Œæ•´çš„é¡¹ç›®ä¸Šä¸‹æ–‡ã€‚

## å‰åç«¯è”è°ƒæ¸…å•

### âœ… å·²å¯¹æ¥é¡¹ç›®

| æ¨¡å— | å‰ç«¯æ¥å£æ•° | åç«¯æ¥å£æ•° | çŠ¶æ€ |
|------|-----------|-----------|------|
| è®¤è¯æ¨¡å— | 4 | 4 | âœ… å®Œå…¨å¯¹æ¥ |
| ç”¨æˆ·æ¨¡å— | 7 | 7 | âœ… å®Œå…¨å¯¹æ¥ |
| ç¬”è®°æ¨¡å— | 8 | 8 | âœ… å®Œå…¨å¯¹æ¥ |
| è¯„è®ºæ¨¡å— | 5 | 5 | âœ… å®Œå…¨å¯¹æ¥ |
| å•†å®¶æ¨¡å— | 6 | 6 | âœ… å®Œå…¨å¯¹æ¥ |
| æ¶ˆæ¯æ¨¡å— | 6 | 6 | âœ… å®Œå…¨å¯¹æ¥ |
| ä¸Šä¼ æ¨¡å— | 2 | 1 | âœ… å®Œå…¨å¯¹æ¥ï¼ˆå‰ç«¯æ‰¹é‡ä¸Šä¼ é€šè¿‡å¹¶å‘å®ç°ï¼‰ |
| å…¬å…±æ¨¡å— | 7 | 7 | âœ… å®Œå…¨å¯¹æ¥ |
| **æ€»è®¡** | **45** | **44** | âœ… **100%å¯¹æ¥** |

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–
- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- ä½¿ç”¨MyBatis-Plusçš„åˆ†é¡µæ’ä»¶
- é¿å…N+1æŸ¥è¯¢ï¼Œä½¿ç”¨JOIN
- å¤§æ•°æ®é‡è¡¨è€ƒè™‘åˆ†è¡¨

### 2. ç¼“å­˜ç­–ç•¥
- çƒ­ç‚¹æ•°æ®ä½¿ç”¨Redisç¼“å­˜
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- æ›´æ–°æ•°æ®æ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
- ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€

### 3. å¼‚æ­¥å¤„ç†
- æµè§ˆé‡ã€ç‚¹èµæ•°ç­‰ç»Ÿè®¡ä½¿ç”¨å¼‚æ­¥æ›´æ–°
- å‘é€é€šçŸ¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
- å›¾ç‰‡ä¸Šä¼ ä½¿ç”¨å¼‚æ­¥å¤„ç†

### 4. æ¥å£é™æµ
```java
@RateLimiter(rate = 10, timeout = 1000)
@PostMapping("/send-code")
public Result<?> sendCode(@RequestBody SendCodeRequest request) {
    // ...
}
```

---

## å®‰å…¨å»ºè®®

1. **å‚æ•°æ ¡éªŒ**ï¼šä½¿ç”¨JSR-303æ³¨è§£è¿›è¡Œå‚æ•°æ ¡éªŒ
2. **SQLæ³¨å…¥**ï¼šä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
3. **XSSé˜²æŠ¤**ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLè½¬ä¹‰
4. **æ•æ„Ÿè¯è¿‡æ»¤**ï¼šä½¿ç”¨DFAç®—æ³•è¿›è¡Œé«˜æ•ˆè¿‡æ»¤
5. **æ¥å£åŠ å¯†**ï¼šHTTPSä¼ è¾“
6. **é˜²åˆ·æœºåˆ¶**ï¼šéªŒè¯ç ã€é™æµã€IPé»‘åå•

---

## éƒ¨ç½²å»ºè®®

### Dockeréƒ¨ç½²
```dockerfile
FROM openjdk:11-jre-slim
WORKDIR /app
COPY target/business-reviews-api.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### Nginxé…ç½®
```nginx
server {
    listen 80;
    server_name api.business-reviews.com;
    
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v2.0.0  
**æœ€åæ›´æ–°ï¼š** 2024-12-03  
**å¯¹æ¥çŠ¶æ€ï¼š** âœ… ä¸å‰ç«¯APIå®Œå…¨å¯¹æ¥ï¼Œå¯ç›´æ¥è¿›è¡Œè”è°ƒ
