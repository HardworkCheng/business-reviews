# 新用户随机头像功能说明

## 功能概述

新用户通过手机号注册登录时,系统会自动从10张预设头像中随机选择一张作为用户的默认头像,并将头像URL写入数据库。

## 实现细节

### 1. 头像资源

**存储位置**: 阿里云OSS
**Bucket**: `cheng-9` (北京地域)
**路径**: `head_photo/headphoto/`
**数量**: 10张头像 (head1.png ~ head10.png)

**完整URL列表**:
```
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head1.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head2.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head3.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head4.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head5.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head6.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head7.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head8.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head9.png
https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head10.png
```

### 2. 代码实现

#### 修改文件1: `UserServiceImpl.java`

**路径**: `backend-business-reviews/src/main/java/com/businessreviews/service/impl/UserServiceImpl.java`

**修改内容**:
1. 添加头像URL常量数组 `DEFAULT_AVATARS`
2. 添加随机数生成器 `RANDOM`
3. 添加随机获取头像方法 `getRandomAvatar()`
4. 在 `register()` 方法中调用 `getRandomAvatar()`

**核心代码**:
```java
// 头像列表
private static final String[] DEFAULT_AVATARS = {
    "https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head1.png",
    // ... 其他9张
};

private static final Random RANDOM = new Random();

// 随机获取头像
private String getRandomAvatar() {
    int index = RANDOM.nextInt(DEFAULT_AVATARS.length);
    String avatar = DEFAULT_AVATARS[index];
    log.info("为新用户随机分配头像: {}", avatar);
    return avatar;
}

// 注册方法
public User register(String phone) {
    User user = new User();
    user.setPhone(phone);
    user.setUsername("用户" + phone.substring(7));
    user.setAvatar(getRandomAvatar()); // 随机头像
    // ...
}
```

#### 修改文件2: `AuthServiceImpl.java`

**路径**: `backend-business-reviews/src/main/java/com/businessreviews/service/impl/AuthServiceImpl.java`

**修改内容**:
1. 添加头像URL常量数组 `DEFAULT_AVATARS`
2. 添加随机数生成器 `RANDOM`
3. 添加随机获取头像方法 `getRandomAvatar()`
4. 在 `registerNewUser()` 方法中调用 `getRandomAvatar()`

**核心代码**:
```java
// 验证码登录时自动注册
private User registerNewUser(String phone) {
    User user = new User();
    user.setPhone(phone);
    user.setUsername("用户" + phone.substring(7));
    user.setAvatar(getRandomAvatar()); // 随机头像
    user.setPassword(phone);
    // ...
}
```

### 3. 触发场景

随机头像分配会在以下两个场景触发:

1. **验证码登录注册** (`AuthServiceImpl.loginByCode`)
   - 用户首次使用手机号+验证码登录
   - 系统检测到用户不存在
   - 自动注册并分配随机头像

2. **直接调用注册接口** (`UserServiceImpl.register`)
   - 某些场景下直接调用注册方法
   - 创建新用户并分配随机头像

### 4. 数据库存储

**表名**: `users`
**字段**: `avatar` (VARCHAR(500))
**存储内容**: 完整的头像URL

**示例**:
```sql
INSERT INTO users (phone, username, avatar, status) 
VALUES ('13800138000', '用户8000', 'https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head5.png', 1);
```

## 测试步骤

### 1. 准备工作
- 确保后端服务已启动
- 确保数据库连接正常
- 清空或准备测试用的手机号

### 2. 测试步骤

#### 方式1: 前端测试
1. 打开前端登录页面
2. 输入一个未注册的手机号(例如: 13900001111)
3. 点击"获取验证码"
4. 输入收到的验证码
5. 点击"登录"
6. 进入个人中心查看头像

#### 方式2: API测试 (Postman/Apifox)

**请求1: 发送验证码**
```http
POST http://localhost:8080/api/auth/send-code
Content-Type: application/json

{
  "phone": "13900001111",
  "type": 1
}
```

**请求2: 验证码登录**
```http
POST http://localhost:8080/api/auth/login-by-code
Content-Type: application/json

{
  "phone": "13900001111",
  "code": "123456"
}
```

**响应示例**:
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "userId": "123",
      "username": "用户1111",
      "avatar": "https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head3.png",
      "phone": "139****1111"
    }
  }
}
```

### 3. 验证结果

#### 数据库验证
```sql
-- 查询最新注册的用户
SELECT id, phone, username, avatar, created_at 
FROM users 
ORDER BY created_at DESC 
LIMIT 10;
```

**预期结果**:
- `avatar` 字段包含完整的OSS URL
- URL格式: `https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head{1-10}.png`
- 多次注册不同用户,头像应该随机分配

#### 前端验证
1. **个人中心页面** (`pages/profile/profile.vue`)
   - 头像应该正常显示
   - 头像为10张预设图之一

2. **设置页面** (`pages/settings/settings.vue`)
   - 顶部圆形头像应该显示
   - 头像URL与数据库一致

#### 后端日志验证
查看控制台日志,应该有类似输出:
```
INFO  c.b.s.i.AuthServiceImpl - 开始注册新用户,手机号: 13900001111
INFO  c.b.s.i.AuthServiceImpl - 为新用户随机分配头像: https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head7.png
INFO  c.b.s.i.AuthServiceImpl - 用户插入结果: 1, 用户ID: 123
INFO  c.b.s.i.AuthServiceImpl - 用户统计插入结果: 1, 统计ID: 123
```

### 4. 多次测试
为了验证随机性,建议注册多个测试账号:
```
13900001111  ->  可能得到 head3.png
13900002222  ->  可能得到 head8.png
13900003333  ->  可能得到 head1.png
13900004444  ->  可能得到 head7.png
13900005555  ->  可能得到 head5.png
```

每个用户应该获得不同的头像(虽然理论上可能重复,但概率较低)。

## 注意事项

### 1. OSS权限
- 确保OSS Bucket权限设置为"公共读"
- 否则前端无法加载头像
- 检查方法: 在浏览器直接访问头像URL

### 2. CORS配置
如果前端访问头像出现跨域错误:
- 登录阿里云OSS控制台
- 进入Bucket -> 权限管理 -> 跨域设置
- 添加CORS规则,允许你的前端域名

### 3. URL有效性
- 定期检查OSS中的头像文件是否存在
- 不要删除或移动这10张头像
- 如果修改了头像位置,需要同步更新代码中的URL

### 4. 扩展性
如果需要添加更多头像:
1. 上传新头像到OSS
2. 修改 `DEFAULT_AVATARS` 数组,添加新URL
3. 重新编译部署

### 5. 性能
- 头像URL存储在数据库,无需每次访问OSS
- 前端直接从OSS加载图片,CDN加速
- Random生成器使用 `java.util.Random`,性能足够

## 后续优化建议

### 1. 配置化
将头像URL列表移到配置文件:
```yaml
app:
  default-avatars:
    - https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head1.png
    - https://cheng-9.oss-cn-beijing.aliyuncs.com/head_photo/headphoto/head2.png
    # ...
```

### 2. 数据库表
创建默认头像表:
```sql
CREATE TABLE default_avatars (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  avatar_url VARCHAR(500) NOT NULL,
  is_active TINYINT DEFAULT 1,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 3. 管理后台
提供管理界面:
- 上传新的默认头像
- 启用/禁用某些头像
- 查看各头像使用统计

### 4. 更智能的分配
- 记录每个头像被使用的次数
- 优先分配使用次数少的头像
- 实现更均衡的分布

## 总结

✅ **已完成**:
1. 在 `UserServiceImpl.java` 中添加随机头像逻辑
2. 在 `AuthServiceImpl.java` 中添加随机头像逻辑
3. 使用阿里云OSS存储的10张头像
4. 自动写入数据库
5. 添加日志记录

✅ **测试方法**:
1. 注册新用户
2. 检查数据库 `users.avatar` 字段
3. 前端查看头像显示
4. 多次测试验证随机性

✅ **效果**:
- 每个新用户都有个性化的头像
- 不再是统一的默认头像
- 提升用户体验
- 头像直接从OSS加载,速度快

现在重启后端服务,注册新用户测试吧! 🎉
