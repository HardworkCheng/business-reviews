# 笔记编辑功能实现文档

## 功能概述
为UniApp移动端添加笔记编辑功能，允许用户编辑自己发布的笔记，包括标题、内容、图片、话题、商户和位置信息。

## 实现内容

### 1. 笔记详情页添加编辑按钮

**文件**: `front-business-reviews-Mobile/src/pages/note-detail/note-detail.vue`

**修改内容**:
- 在顶部导航栏添加编辑按钮
- 编辑按钮使用 `/static/icons/edit.png` 图标
- 只有笔记作者可见编辑按钮（通过 `noteData.isAuthor` 判断）
- 点击编辑按钮跳转到编辑页面

**关键代码**:
```vue
<!-- 编辑按钮 - 只有作者可见 -->
<view v-if="noteData.isAuthor" class="nav-btn edit-btn" @click="editNote">
  <image src="/static/icons/edit.png" class="edit-icon" mode="aspectFit"></image>
</view>
```

```javascript
// 编辑笔记
const editNote = () => {
  if (!noteId.value) {
    uni.showToast({
      title: '无法获取笔记信息',
      icon: 'none'
    })
    return
  }
  
  uni.navigateTo({
    url: `/pages/note-edit/note-edit?id=${noteId.value}`
  })
}
```

### 2. 创建笔记编辑页面

**文件**: `front-business-reviews-Mobile/src/pages/note-edit/note-edit.vue`

**功能特性**:
1. **数据回显**: 加载笔记详情并自动填充所有字段
   - 标题
   - 内容
   - 图片列表
   - 关联商户
   - 话题标签
   - 位置信息

2. **编辑功能**:
   - 修改标题和内容
   - 添加/删除图片（最多9张）
   - 选择/更换关联商户
   - 添加/移除话题标签（最多5个）
   - 选择/更换位置

3. **图片处理**:
   - 保留原有图片URL
   - 支持添加新图片
   - 只上传新添加的图片
   - 合并原有和新上传的图片URL

4. **数据验证**:
   - 标题至少2个字
   - 内容至少10个字
   - 至少1张图片
   - 字数限制提示

5. **用户体验**:
   - 加载中提示
   - 保存中提示
   - 成功/失败提示
   - 取消编辑确认

### 3. 添加编辑API

**文件**: `front-business-reviews-Mobile/src/api/note.js`

**新增API**:
```javascript
/**
 * 更新笔记
 * @param {String} id - 笔记ID
 * @param {Object} data - 笔记数据
 */
export const updateNote = (id, data) => {
  return post(`/notes/${id}`, data)
}
```

### 4. 注册路由

**文件**: `front-business-reviews-Mobile/src/pages.json`

**添加路由配置**:
```json
{
  "path": "pages/note-edit/note-edit",
  "style": {
    "navigationBarTitleText": "编辑笔记",
    "navigationStyle": "custom"
  }
}
```

## 时间更新机制

### 后端要求
后端在处理笔记更新时需要：
1. 更新 `updated_at` 字段为当前时间
2. 返回更新后的笔记数据，包含最新的 `updated_at`
3. 在笔记列表和详情接口中返回 `updated_at` 字段

### 前端显示
1. **笔记详情页**: 显示 `updated_at` 时间（如果有），否则显示 `created_at`
2. **首页列表**: 显示最新的时间（优先 `updated_at`）
3. **时间格式化**: 使用相对时间格式（刚刚、X分钟前、X小时前等）

## 使用流程

### 用户操作流程
1. 用户打开自己发布的笔记详情页
2. 点击右上角的编辑按钮（铅笔图标）
3. 进入编辑页面，所有信息自动回显
4. 修改需要更改的内容
5. 点击"保存"按钮
6. 系统验证数据并上传新图片
7. 调用更新API保存修改
8. 显示成功提示并返回详情页
9. 详情页显示更新后的内容和时间

### 技术流程
```
1. 点击编辑按钮
   ↓
2. 跳转到编辑页面（携带笔记ID）
   ↓
3. 加载笔记详情数据
   ↓
4. 回显所有字段
   ↓
5. 用户修改内容
   ↓
6. 点击保存
   ↓
7. 验证数据
   ↓
8. 上传新图片（如果有）
   ↓
9. 合并图片URL
   ↓
10. 调用更新API
   ↓
11. 返回详情页
   ↓
12. 刷新详情页数据
```

## 关键代码说明

### 数据回显
```javascript
const fetchNoteDetail = async (id) => {
  const result = await getNoteDetail(id)
  
  // 回显基本信息
  title.value = result.title || ''
  content.value = result.content || ''
  imageList.value = result.images || []
  originalImages.value = result.images || []
  
  // 回显位置
  location.value = result.location || ''
  latitude.value = result.latitude
  longitude.value = result.longitude
  
  // 回显商户
  if (result.shopId && result.shopName) {
    selectedShop.value = {
      id: result.shopId,
      name: result.shopName
    }
  }
  
  // 回显话题
  if (result.topics && result.topics.length > 0) {
    selectedTopics.value = result.topics.map(t => ({
      id: t.id,
      name: t.name
    }))
  }
}
```

### 图片处理
```javascript
// 检查是否有新上传的图片（临时路径）
const newImages = imageList.value.filter(img => 
  img.startsWith('http://tmp/') || img.startsWith('wxfile://')
)

let imageUrls = []

if (newImages.length > 0) {
  // 上传新图片
  const uploadResult = await uploadImages(newImages)
  const newUrls = uploadResult.urls
  
  // 合并图片：保留原有的URL，替换新上传的
  imageUrls = imageList.value.map(img => {
    if (img.startsWith('http://tmp/') || img.startsWith('wxfile://')) {
      return newUrls.shift()
    }
    return img
  })
} else {
  // 没有新图片，使用现有的
  imageUrls = imageList.value
}
```

### 更新提交
```javascript
const handleUpdate = async () => {
  // 验证数据
  // ...
  
  // 处理图片
  // ...
  
  // 构建更新数据
  const noteData = {
    title: title.value.trim(),
    content: content.value.trim(),
    images: imageUrls,
    shopId: selectedShop.value ? selectedShop.value.id : null,
    location: location.value || null,
    latitude: latitude.value,
    longitude: longitude.value,
    topics: selectedTopics.value.filter(t => t.id).map(t => t.id)
  }
  
  // 调用更新API
  await updateNote(noteId.value, noteData)
  
  // 返回详情页
  uni.navigateBack()
}
```

## 样式设计

编辑页面复用了发布页面的样式，保持UI一致性：
- 顶部导航栏：取消按钮 + 保存按钮
- 标题输入框
- 内容输入框（带字数统计）
- 图片九宫格
- 选项列表（话题、商户、位置）
- 弹窗样式（话题选择、商户选择）

## 注意事项

1. **权限控制**: 只有笔记作者才能看到编辑按钮
2. **数据验证**: 前端和后端都需要验证数据完整性
3. **图片优化**: 只上传新添加的图片，避免重复上传
4. **错误处理**: 提供友好的错误提示
5. **用户体验**: 加载和保存过程中显示提示信息
6. **数据同步**: 编辑成功后需要刷新详情页数据

## 后端API要求

### 更新笔记接口
```
POST /notes/{id}
```

**请求参数**:
```json
{
  "title": "笔记标题",
  "content": "笔记内容",
  "images": ["图片URL1", "图片URL2"],
  "shopId": 123,
  "location": "位置名称",
  "latitude": 39.9,
  "longitude": 116.4,
  "topics": [1, 2, 3]
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "id": 1,
    "title": "笔记标题",
    "content": "笔记内容",
    "images": ["图片URL1", "图片URL2"],
    "createdAt": "2025-12-25T10:00:00",
    "updatedAt": "2025-12-25T14:30:00"
  }
}
```

**注意事项**:
1. 需要验证用户是否为笔记作者
2. 更新 `updated_at` 字段
3. 返回完整的笔记数据
4. 处理话题关联关系

## 测试建议

1. **功能测试**:
   - 编辑按钮显示/隐藏
   - 数据回显正确性
   - 各字段修改功能
   - 图片添加/删除
   - 保存成功/失败

2. **边界测试**:
   - 最少字数限制
   - 最多字数限制
   - 图片数量限制
   - 话题数量限制

3. **异常测试**:
   - 网络异常
   - 权限异常
   - 数据异常

## 完成状态

✅ 笔记详情页添加编辑按钮
✅ 创建笔记编辑页面
✅ 实现数据回显功能
✅ 实现编辑保存功能
✅ 添加编辑API
✅ 注册路由配置
✅ 样式设计完成
✅ 文档编写完成

## 后续优化建议

1. 添加草稿保存功能
2. 支持图片裁剪和滤镜
3. 添加编辑历史记录
4. 支持批量编辑
5. 添加编辑权限管理
6. 优化图片上传性能
7. 添加离线编辑支持
