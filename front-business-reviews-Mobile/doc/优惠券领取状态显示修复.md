# 优惠券领取状态显示修复

## 问题描述

用户在领券中心领取优惠券后，按钮仍然显示"领取"而不是"已领取"图标，导致用户可能重复点击领取。

## 问题原因

前端调用 `getAvailableCoupons` API 时使用了 `{ noAuth: true }` 选项，导致请求不携带用户token。后端无法获取 `userId`，因此无法判断用户是否已领取该优惠券，所有优惠券的 `status` 都返回为 `available`。

## 解决方案

### 1. 修改前端API调用

**文件**: `front-business-reviews-Mobile/src/api/coupon.js`

移除 `getAvailableCoupons` 函数中的 `{ noAuth: true }` 选项：

```javascript
export const getAvailableCoupons = (pageNum = 1, pageSize = 20, keyword = '', type = null) => {
  const params = { pageNum, pageSize }
  if (keyword) params.keyword = keyword
  if (type) params.type = type
  // 移除 noAuth，让请求在用户登录时携带token
  return get('/app/coupons/available', params)
}
```

### 2. 优化领取成功后的状态更新

**文件**: `front-business-reviews-Mobile/src/pages/discount/discount.vue`

修改 `claimCoupon` 函数，确保领取成功后：
1. 立即更新本地优惠券对象的 `status` 为 `'claimed'`
2. 在 `availableCoupons` 数组中找到对应优惠券并更新状态
3. 延迟500ms后刷新优惠券列表，确保后端状态已更新

```javascript
const claimCoupon = async (coupon) => {
  // ... 验证逻辑 ...
  
  try {
    const response = await couponApi.receiveCoupon(coupon.id)
    
    // 立即更新本地状态
    coupon.status = 'claimed'
    
    // 在数组中更新
    const index = availableCoupons.value.findIndex(c => c.id === coupon.id)
    if (index !== -1) {
      availableCoupons.value[index].status = 'claimed'
    }
    
    showToast('领取成功！已存入券包', 'success')
    fetchMyCoupons()
    
    // 延迟刷新确保后端状态已更新
    setTimeout(() => {
      fetchAvailableCoupons()
    }, 500)
  } catch (e) {
    // ... 错误处理 ...
  }
}
```

### 3. 添加图标显示

在模板中使用条件渲染显示不同状态的图标：

```vue
<view class="btn-icon-wrapper" @click.stop="claimCoupon(coupon)">
  <image 
    v-if="coupon.status === 'available'" 
    src="/static/icons/coupon-claim.png" 
    class="btn-icon"
    mode="aspectFit"
  />
  <image 
    v-else-if="coupon.status === 'claimed'" 
    src="/static/icons/coupon-claimed.png" 
    class="btn-icon"
    mode="aspectFit"
  />
  <button v-else class="btn-get" :class="getCouponBtnClass(coupon.status)">
    {{ getCouponBtnText(coupon.status) }}
  </button>
</view>
```

## 后端逻辑说明

后端 `CouponController.convertToCouponResponse` 方法会检查用户是否已领取：

```java
// 检查用户是否已领取
if (userId != null) {
    LambdaQueryWrapper<UserCouponDO> wrapper = new LambdaQueryWrapper<>();
    wrapper.eq(UserCouponDO::getUserId, userId)
           .eq(UserCouponDO::getCouponId, coupon.getId());
    Long count = userCouponMapper.selectCount(wrapper);
    map.put("isReceived", count > 0);
    if (count > 0 && !"sold_out".equals(status)) {
        status = "claimed";
    }
}
```

## 可选认证机制

后端 `AuthInterceptor` 对 `/app/coupons/` 和 `/app/seckill/` 路径实现了可选认证：
- 如果请求携带有效token，解析userId并返回个性化状态
- 如果请求不携带token，以游客身份返回通用数据

这样既支持未登录用户浏览优惠券，又能为已登录用户显示正确的领取状态。

## 测试验证

1. 未登录状态：所有优惠券显示"领取"图标
2. 登录后：
   - 未领取的优惠券显示"领取"图标（橙色）
   - 已领取的优惠券显示"已领取"图标（灰色+绿色勾选）
3. 领取成功后：图标立即从"领取"变为"已领取"
4. 刷新页面：已领取的优惠券仍然显示"已领取"图标

## 修复日期

2025年12月22日
