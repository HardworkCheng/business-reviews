# 笔记分享功能后端实现

## 实现时间
2025-12-25

## 问题描述
前端点击分享按钮时出现错误：
- 前端错误：`分享失败: {code: 50000, message: '系统繁忙，请稍后再试', success: false}`
- 后端错误：`No static resource messages/share-note`

原因：后端缺少 `/app/messages/share-note` API 端点

## 实现内容

### 1. 数据库修改
**文件**: `backend-business-reviews/sql/add_note_data_to_messages.sql`

添加 `note_data` 字段到 `messages` 表：
```sql
ALTER TABLE messages ADD COLUMN note_data TEXT COMMENT '笔记数据（JSON格式，用于笔记分享消息）' AFTER type;
ALTER TABLE messages MODIFY COLUMN type INT DEFAULT 1 COMMENT '消息类型：1=文本，2=图片，3=语音，4=笔记分享';
```

### 2. 实体类修改
**文件**: `backend-business-reviews/backend-business-reviews-entity/src/main/java/com/businessreviews/model/dataobject/MessageDO.java`

添加 `noteData` 字段：
```java
private Integer type; // 1=文本, 2=图片, 4=笔记分享
private String noteData; // 笔记数据（JSON格式）
```

### 3. 新增 DTO
**文件**: `backend-business-reviews/backend-business-reviews-entity/src/main/java/com/businessreviews/model/dto/app/ShareNoteDTO.java`

```java
@Data
public class ShareNoteDTO {
    @NotNull(message = "笔记ID不能为空")
    private Long noteId;
    
    @NotEmpty(message = "接收者列表不能为空")
    private List<Long> userIds;
}
```

### 4. Service 接口
**文件**: `backend-business-reviews/backend-business-reviews-service/src/main/java/com/businessreviews/service/app/MessageService.java`

添加方法：
```java
void shareNoteToUsers(Long userId, Long noteId, List<Long> userIds);
```

### 5. Service 实现
**文件**: `backend-business-reviews/backend-business-reviews-service/src/main/java/com/businessreviews/service/impl/app/MessageServiceImpl.java`

实现 `shareNoteToUsers` 方法：
- 验证笔记存在性
- 验证用户存在性
- 构建笔记数据 JSON
- 给每个接收者创建消息记录（type=4）
- 通过 WebSocket 实时推送消息

### 6. Controller 端点
**文件**: `backend-business-reviews/backend-business-reviews-web/src/main/java/com/businessreviews/web/app/MessageController.java`

添加端点：
```java
@PostMapping("/share-note")
public Result<?> shareNote(@RequestBody @Valid ShareNoteDTO request) {
    Long userId = UserContext.requireUserId();
    messageService.shareNoteToUsers(userId, request.getNoteId(), request.getUserIds());
    return Result.success("分享成功");
}
```

## API 说明

### 请求
- **URL**: `POST /app/messages/share-note`
- **Headers**: `Authorization: Bearer {token}`
- **Body**:
```json
{
  "noteId": 123,
  "userIds": [1, 2, 3]
}
```

### 响应
```json
{
  "code": 20000,
  "message": "分享成功",
  "success": true
}
```

## 消息格式

分享的笔记消息存储格式：
- `type`: 4（笔记分享类型）
- `content`: "分享了一篇笔记"
- `note_data`: JSON 字符串
```json
{
  "noteId": 123,
  "title": "笔记标题",
  "coverImage": "图片URL",
  "content": "笔记内容摘要（前50字）"
}
```

## WebSocket 推送

实时推送消息格式：
```json
{
  "type": "private_message",
  "data": {
    "id": 消息ID,
    "senderId": 发送者ID,
    "receiverId": 接收者ID,
    "content": "分享了一篇笔记",
    "messageType": 4,
    "createdAt": "创建时间",
    "senderName": "发送者用户名",
    "senderAvatar": "发送者头像",
    "noteData": {
      "noteId": 笔记ID,
      "title": "笔记标题",
      "coverImage": "封面图片",
      "content": "内容摘要"
    }
  }
}
```

## 部署步骤

1. **执行数据库迁移**:
```bash
mysql -u root -p business_reviews < backend-business-reviews/sql/add_note_data_to_messages.sql
```

2. **重启后端服务**:
```bash
cd backend-business-reviews
mvn clean package
# 重启 Spring Boot 应用
```

3. **测试功能**:
- 登录移动端
- 打开笔记详情
- 点击分享按钮
- 选择要分享的用户
- 点击分享
- 检查接收者的聊天列表是否收到笔记卡片

## 注意事项

1. 需要先执行 SQL 迁移脚本添加 `note_data` 字段
2. 笔记分享消息类型为 4
3. 前端已实现笔记卡片显示（chat.vue）
4. WebSocket 实时推送已集成
5. 分享失败时会记录日志但不影响其他用户

## 相关文件

- 前端实现：`front-business-reviews-Mobile/doc/笔记分享功能实现.md`
- 分享页面：`front-business-reviews-Mobile/src/pages/note-share/note-share.vue`
- 聊天页面：`front-business-reviews-Mobile/src/pages/chat/chat.vue`
- API 文件：`front-business-reviews-Mobile/src/api/message.js`
