# 商家运营中心刷新后需要重新登录问题修复

## 问题描述

商家运营中心（Web端）每次刷新页面后都需要重新登录，无法保持登录状态。

## 问题分析

### 症状表现
- 用户登录成功后，刷新页面会被重定向到登录页
- 控制台显示 `Token有效: false`
- localStorage 中的 `merchant_token` 在刷新后不存在

### 根本原因

在 `front-business-reviews-Web/src/main.ts` 文件中存在以下代码：

```typescript
// 应用启动时清除登录状态，强制用户重新登录
localStorage.removeItem('merchant_token')
console.log('[App] 已清除登录状态，需要重新登录')
```

这段代码会在每次应用启动时（包括页面刷新）清除存储在 localStorage 中的 token，导致：

1. 用户登录成功 → token 存入 localStorage
2. 用户刷新页面 → main.ts 执行，清除 token
3. 路由守卫检查 token → 发现 token 不存在
4. 重定向到登录页

### 问题来源推测

这段代码可能是在开发调试阶段添加的，用于方便测试登录功能，但忘记在发布前移除。

## 解决方案

### 修改文件
`front-business-reviews-Web/src/main.ts`

### 修改内容
移除以下代码：

```typescript
// 应用启动时清除登录状态，强制用户重新登录
localStorage.removeItem('merchant_token')
console.log('[App] 已清除登录状态，需要重新登录')
```

### 修改后的 main.ts

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router'
import { createPinia } from 'pinia'
import ElementPlus from 'element-plus'
import 'element-plus/dist/index.css'
import * as ElementPlusIconsVue from '@element-plus/icons-vue'

// 引入自定义主题样式
import './styles/variables.scss'
import './styles/common.scss'
import './styles/element-plus.scss'

const app = createApp(App)

// 注册所有Element Plus图标
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}

app.use(createPinia())
app.use(router)
app.use(ElementPlus)

app.mount('#app')
```

## 相关文件说明

### Token 存储流程

1. **登录页面** (`src/views/login/index.vue`)
   - 登录成功后调用 `userStore.setToken(res.token)`

2. **用户状态管理** (`src/stores/user.ts`)
   - `setToken()` 方法将 token 存入 localStorage
   ```typescript
   setToken(token: string) {
     this.token = token
     localStorage.setItem('merchant_token', token)
   }
   ```

3. **路由守卫** (`src/router/index.ts`)
   - 从 localStorage 读取 token 并验证格式
   - 验证失败则重定向到登录页

4. **请求拦截器** (`src/api/request.ts`)
   - 从 localStorage 读取 token 添加到请求头
   - 收到 401 响应时清除 token 并跳转登录页

## 验证方法

1. 启动商家运营中心
2. 使用账号密码登录
3. 登录成功后刷新页面
4. 确认页面保持在当前位置，不会跳转到登录页
5. 打开浏览器开发者工具 → Application → Local Storage
6. 确认 `merchant_token` 在刷新后仍然存在

## 修复日期

2025年12月22日

## 注意事项

- 如果需要在开发时强制清除登录状态，可以手动在浏览器控制台执行：
  ```javascript
  localStorage.removeItem('merchant_token')
  ```
- 或者在浏览器开发者工具中直接删除 localStorage 中的 `merchant_token` 项
- 不要在生产代码中添加自动清除 token 的逻辑
