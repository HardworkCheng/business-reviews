# 笔记分享功能实现文档

## 功能概述

实现笔记分享功能，允许用户将笔记分享给关注的人或粉丝，分享的笔记在聊天页面以卡片形式展示，点击可跳转到笔记详情。

## 功能特性

1. ✅ 替换分享按钮图标为 `/static/icons/share.png`
2. ✅ 创建分享页面，选择关注的人或粉丝
3. ✅ 如果没有关注或粉丝，显示空状态提示
4. ✅ 在聊天页面显示笔记卡片
5. ✅ 点击笔记卡片跳转到笔记详情

## 实现步骤

### 1. 修改笔记详情页面

**文件**: `front-business-reviews-Mobile/src/pages/note-detail/note-detail.vue`

**修改内容**:
- 替换分享按钮图标
- 修改 `shareNote()` 方法，跳转到分享页面

```vue
<!-- 分享按钮 -->
<view class="nav-btn-icon" @click="shareNote">
    <image src="/static/icons/share.png" class="share-icon" mode="aspectFit"></image>
</view>

<script>
const shareNote = () => {
    uni.navigateTo({
        url: `/pages/note-share/note-share?noteId=${noteId.value}`
    })
}
</script>
```

### 2. 创建分享页面

**文件**: `front-business-reviews-Mobile/src/pages/note-share/note-share.vue`

**功能**:
- 显示笔记预览卡片
- 显示关注列表和粉丝列表
- 支持搜索用户
- 多选用户
- 分享笔记

**页面结构**:
```
- 顶部导航
- 笔记预览卡片
- 搜索框
- 用户列表
  - 我关注的人
  - 我的粉丝
- 底部操作栏
  - 已选择数量
  - 分享按钮
```

### 3. 添加分享API

**文件**: `front-business-reviews-Mobile/src/api/message.js`

**新增API**:
```javascript
/**
 * 分享笔记给用户
 * @param {String} noteId - 笔记ID
 * @param {Array} userIds - 用户ID列表
 */
export const shareNoteToUsers = (noteId, userIds) => {
  return post('/messages/share-note', {
    noteId,
    userIds
  })
}
```

### 4. 修改聊天页面

**文件**: `front-business-reviews-Mobile/src/pages/chat/chat.vue`

**修改内容**:
- 支持显示笔记卡片消息
- 点击笔记卡片跳转到笔记详情

**消息类型**:
- `messageType: 1` - 文本消息
- `messageType: 4` - 笔记分享消息（新增）

**笔记卡片结构**:
```json
{
  "messageType": 4,
  "content": "分享了一篇笔记",
  "noteData": {
    "noteId": 123,
    "title": "笔记标题",
    "coverImage": "图片URL",
    "content": "笔记内容摘要"
  }
}
```

## 后端API需求

### 1. 分享笔记API

**接口**: `POST /app/messages/share-note`

**请求参数**:
```json
{
  "noteId": 123,
  "userIds": [1, 2, 3]
}
```

**响应**:
```json
{
  "code": 200,
  "message": "分享成功",
  "data": {
    "successCount": 3,
    "failedCount": 0
  }
}
```

**功能**:
- 向指定用户发送笔记分享消息
- 消息类型为 4（笔记分享）
- 消息内容包含笔记信息

### 2. 获取关注列表API

**接口**: `GET /app/users/following`

**请求参数**:
- `pageNum`: 页码
- `pageSize`: 每页数量

**响应**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 1,
        "username": "用户名",
        "avatar": "头像URL",
        "bio": "个人简介"
      }
    ],
    "total": 10
  }
}
```

### 3. 获取粉丝列表API

**接口**: `GET /app/users/followers`

**请求参数**:
- `pageNum`: 页码
- `pageSize`: 每页数量

**响应**:
```json
{
  "code": 200,
  "data": {
    "list": [
      {
        "id": 2,
        "username": "用户名",
        "avatar": "头像URL",
        "bio": "个人简介"
      }
    ],
    "total": 5
  }
}
```

## 数据库设计

### messages表修改

需要支持存储笔记分享消息的额外数据：

```sql
ALTER TABLE messages ADD COLUMN note_id BIGINT NULL COMMENT '分享的笔记ID（消息类型为4时使用）';
ALTER TABLE messages ADD COLUMN note_data TEXT NULL COMMENT '笔记数据JSON（消息类型为4时使用）';
```

或者使用现有的 `content` 字段存储JSON数据。

## 测试用例

### 测试1：分享笔记给关注的人
1. 打开笔记详情页
2. 点击分享按钮
3. 选择1个或多个关注的人
4. 点击分享按钮
5. **预期**: 分享成功，返回笔记详情页

### 测试2：分享笔记给粉丝
1. 打开笔记详情页
2. 点击分享按钮
3. 选择1个或多个粉丝
4. 点击分享按钮
5. **预期**: 分享成功，返回笔记详情页

### 测试3：没有关注或粉丝
1. 打开笔记详情页
2. 点击分享按钮
3. **预期**: 显示空状态提示"暂无可分享的用户"

### 测试4：查看分享的笔记
1. 打开聊天页面
2. 查看收到的笔记分享消息
3. **预期**: 显示笔记卡片（封面图、标题、内容摘要）

### 测试5：点击笔记卡片
1. 在聊天页面点击笔记卡片
2. **预期**: 跳转到笔记详情页

### 测试6：搜索用户
1. 在分享页面输入用户名
2. **预期**: 过滤显示匹配的用户

## 注意事项

1. **权限检查**: 只能分享给关注的人或粉丝
2. **笔记状态**: 只能分享状态为公开的笔记
3. **消息类型**: 笔记分享消息使用 `messageType: 4`
4. **数据格式**: 笔记数据使用JSON格式存储
5. **错误处理**: 分享失败时显示错误提示

## 后续优化

1. 支持分享到群组
2. 支持分享到朋友圈
3. 支持生成分享海报
4. 统计分享次数
5. 分享记录查看
